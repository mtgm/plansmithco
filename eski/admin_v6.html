<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>PlanSmithCo v10.2 (Hotfix)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <style>
        :root { 
            --primary: #3b82f6; --bg: #f8fafc; --surface: #ffffff; --border: #cbd5e1; 
            --text: #1e293b; --danger: #ef4444; --success: #10b981;
            --dark-panel: #0f172a; --dark-surface: #1e293b; --dark-border: #334155; --dark-text: #e2e8f0;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; font-size: 13px; }

        /* LAYOUT */
        aside { width: 260px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        main { flex: 1; display: flex; overflow: hidden; }
        .center-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; max-width: 1200px; margin: 0 auto; width: 100%; }
        .right-panel { width: 340px; background: var(--dark-panel); border-left: 1px solid var(--dark-border); display: flex; flex-direction: column; z-index: 5; color: var(--dark-text); }

        /* SIDEBAR */
        .brand { padding: 20px; font-weight: 800; font-size: 18px; border-bottom: 1px solid var(--border); color: var(--primary); }
        .tree-view { flex: 1; padding: 10px; overflow-y: auto; }
        .tree-cat-group { margin-bottom: 10px; }
        .tree-cat-header { display: flex; justify-content: space-between; padding: 5px 10px; font-weight: 700; font-size: 11px; text-transform: uppercase; color: #64748b; cursor:pointer; }
        .tree-item { padding: 8px 12px; cursor: pointer; font-size: 13px; border-radius: 6px; margin-top: 2px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .tree-item:hover { background: #f1f5f9; }
        .tree-item.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }

        /* --- DOSYA Y√ñNETƒ∞Cƒ∞Sƒ∞ (D√úZELTƒ∞LDƒ∞: S√úTUNLAR VE Sƒ∞L BUTONU) --- */
        #media-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .media-window { width: 90%; height: 90%; background: white; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        
        .mw-toolbar { padding: 10px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; background: #fff; }
        .mw-address { padding: 6px 12px; background: #f1f5f9; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-size: 12px; }
        
        /* ‚ö†Ô∏è D√úZELTME: S√ºtun Hizalamasƒ± (Grid Template - Checkbox s√ºtunu eklendi) */
        .mw-header { 
            display: grid; 
            grid-template-columns: 40px 1fr 150px 100px; /* Checkbox - Ad - Tarih - Boyut */
            padding: 10px 15px; 
            border-bottom: 1px solid var(--border); 
            background: #f8fafc; 
            font-weight: 700; color: #64748b; font-size: 11px;
            gap: 10px;
            align-items: center;
        }
        .mw-body { flex: 1; overflow-y: auto; padding: 10px; background: white; }

        /* G√ñR√úN√úM: LISTE (D√úZELTƒ∞LDƒ∞) */
        .view-list .file-item { 
            display: grid; 
            grid-template-columns: 40px 1fr 150px 100px; /* Header ile AYNI */
            padding: 8px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; align-items: center; gap: 10px;
        }
        .view-list .file-item:hover { background: #f0f9ff; }
        .view-list .file-info-grp { display: flex; align-items: center; overflow: hidden; }
        .view-list .file-thumb { width: 24px; height: 24px; object-fit: contain; margin-right: 10px; border-radius: 3px; border: 1px solid #eee; }
        .view-list .file-icon { font-size: 18px; margin-right: 10px; color: #94a3b8; }
        .view-list .file-name { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .view-list .file-meta { font-size: 12px; color: #64748b; }
        .view-list .file-check { margin: 0; cursor: pointer; transform: scale(1.2); }

        /* G√ñR√úN√úM: IZGARA */
        .view-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        .view-grid .file-item { 
            display: flex; flex-direction: column; align-items: center; border: 1px solid var(--border); 
            border-radius: 6px; padding: 10px; cursor: pointer; height: 140px; position: relative;
        }
        .view-grid .file-item:hover { border-color: var(--primary); background: #f0f9ff; }
        .view-grid .file-thumb { width: 100%; height: 70px; object-fit: contain; margin-bottom: 5px; }
        .view-grid .file-icon { font-size: 40px; margin-bottom: 5px; color: #94a3b8; }
        .view-grid .file-name { font-size: 11px; text-align: center; overflow: hidden; max-height: 35px; width: 100%; }
        .view-grid .file-meta { display: none; }
        .view-grid .file-check { position: absolute; top: 8px; left: 8px; transform: scale(1.2); z-index: 5; }
        .view-grid .file-info-grp { display: contents; }

        .selected-row { background: #e0f2fe !important; border-color: #bae6fd; }

        /* --- VARYASYON GRUPLARI (D√úZELTƒ∞LDƒ∞: YATAY G√ñR√úN√úM) --- */
        .v-group { background: #fff; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .v-header { background: #f1f5f9; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); cursor: pointer; }
        .v-header input { width: 300px; font-weight: 700; background: transparent; border: 1px solid transparent; font-size: 14px; }
        .v-header input:hover { background: white; border-color: var(--border); }
        .v-body { padding: 15px; }
        .v-group.collapsed .v-body { display: none; }

        /* ‚ö†Ô∏è D√úZELTME: YATAY VARYASYON KUTULARI */
        .v-item { 
            display: grid; 
            grid-template-columns: 1.5fr 1.5fr 1fr 1.5fr 40px; /* Geni≈ü yatay s√ºtunlar */
            gap: 15px; 
            align-items: end; 
            background: white; 
            padding: 15px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            margin-bottom: 10px; 
        }
        .v-item-label { font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 6px; }

        /* --- PRO SAƒû PANEL --- */
        .rp-header { padding: 15px; border-bottom: 1px solid var(--dark-border); font-weight: 700; background: var(--dark-surface); color: white; display: flex; align-items: center; gap: 8px; }
        .rp-content { padding: 20px; overflow-y: auto; flex: 1; background: var(--dark-panel); }
        model-viewer#viewer { width: 100%; height: 240px; background: #1e293b; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--dark-border); }
        .mat-list-title { font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .mat-list { background: var(--dark-surface); border: 1px solid var(--dark-border); border-radius: 8px; overflow: hidden; }
        .mat-item { padding: 10px 12px; border-bottom: 1px solid var(--dark-border); cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; color: var(--dark-text); }
        .mat-item:hover { background: var(--primary); color: white; }

        /* --- GENEL UTILS --- */
        .tabs-header { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); padding: 0 20px; gap: 20px; }
        .tab-btn { padding: 15px 5px; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 5px; transition:0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: #475569; }
        
        .hidden { display: none !important; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full { grid-column: span 2; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }
        .input-group-btn { display: flex; gap: 5px; }
        
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="media-modal">
        <div class="media-window">
            <div class="mw-toolbar">
                <button class="btn btn-primary" onclick="document.getElementById('r2-up').click()">‚òÅÔ∏è Y√ºkle</button>
                <input type="file" id="r2-up" hidden onchange="uploadToR2(this.files[0])">
                
                <button class="btn btn-danger" id="btn-delete" style="opacity:0.5; pointer-events:none;" onclick="deleteSelectedFiles()">üóëÔ∏è Sil</button>
                
                <div style="flex:1"></div>
                <button class="btn btn-ghost" onclick="setViewMode('list')">‚ò∞ Liste</button>
                <button class="btn btn-ghost" onclick="setViewMode('grid')">‚ñ¶ Izgara</button>
                <input type="text" placeholder="Ara..." id="search-in" style="width: 200px;" oninput="renderFiles()">
                <button class="btn btn-ghost" style="color:red; border-color:red;" onclick="closeMedia()">‚úï</button>
            </div>
            
            <div class="mw-address">
                <button class="btn btn-ghost" style="padding:2px 6px;" onclick="navUp()">‚¨Ü √úst</button>
                <span id="cur-path" style="font-family:monospace; font-weight:bold; color:#475569;">/</span>
            </div>

            <div id="mw-header" class="mw-header">
                <div></div> <div>Dosya Adƒ±</div>
                <div>Tarih</div>
                <div>Boyut</div>
            </div>

            <div class="mw-body" id="mw-body"></div>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div></div>
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:20px;">PlanSmithCo v10.2</h2>
            <input type="password" id="gh-token" placeholder="GitHub Token" style="margin-bottom:10px;">
            <input type="text" id="gh-owner" placeholder="User" value="mtgm" style="margin-bottom:10px;">
            <input type="text" id="gh-repo" placeholder="Repo" value="plansmithco" style="margin-bottom:10px;">
            <input type="text" id="gh-branch" placeholder="Branch" value="v2-showroom" style="margin-bottom:10px;">
            <input type="text" id="gh-path" placeholder="File" value="products.json" style="margin-bottom:20px;">
            <button class="btn btn-primary" style="width:100%" onclick="startLogin()">Giri≈ü Yap</button>
        </div>
    </div>

    <aside>
        <div class="brand">üöÄ PlanSmithCo.</div>
        <div class="tree-view" id="tree-root"></div>
        <div class="sidebar-footer">
            <button class="btn btn-ghost" style="width:100%; margin-bottom:5px;" onclick="openFileManager()">üìÇ R2 Dosya Y√∂neticisi</button>
            <button class="btn btn-primary" style="width:100%" onclick="newProd()">+ Yeni √úr√ºn</button>
            <button class="btn btn-success" style="width:100%" onclick="newCat()">+ Yeni Kategori</button>
        </div>
    </aside>

    <main>
        <div class="center-panel">
            <div id="editor-area" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                <div class="tabs-header">
                    <div class="tab-btn active" onclick="switchTab('genel')">Genel Bilgiler</div>
                    <div class="tab-btn" onclick="switchTab('varyasyon')">Varyasyonlar & Konfig√ºrasyon</div>
                </div>

                <div class="editor-content">
                    <div id="tab-genel" class="tab-content active">
                        <div class="card">
                            <div class="form-grid">
                                <div class="full"><label>Kategori</label><select id="p-cat" onchange="moveCat()"></select></div>
                                <div><label>√úr√ºn Adƒ±</label><input id="p-name"></div>
                                <div><label>SKU</label><input id="p-sku"></div>
                                <div><label>Fiyat</label><input type="number" id="p-price"></div>
                                <div>
                                    <label>Poster</label>
                                    <div class="input-group-btn">
                                        <input id="p-thumb"><button class="btn btn-primary" onclick="openMedia('p-thumb','image')">Se√ß</button>
                                    </div>
                                </div>
                                <div class="full"><label>A√ßƒ±klama</label><textarea id="p-desc" rows="4"></textarea></div>
                                <div class="full"><label>Etsy Linki</label><input id="p-link"></div>
                                <div class="full">
                                    <label>Model Dosyasƒ± (.glb)</label>
                                    <div class="input-group-btn">
                                        <input id="p-model" onchange="updateGlbPreview()"><button class="btn btn-primary" onclick="openMedia('p-model','model')">Se√ß</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <button class="btn btn-danger" onclick="delProd()">√úr√ºn√º Sil</button>
                            <button class="btn btn-success" onclick="saveGithub()">Kaydet</button>
                        </div>
                    </div>

                    <div id="tab-varyasyon" class="tab-content">
                        <div style="background:#e0f2fe; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; border:1px dashed #3b82f6;">
                            <h4 style="margin:0 0 5px 0; color:#1e40af;">Otomatik Varyasyon</h4>
                            <p style="font-size:11px; margin-bottom:10px; color:#1e40af;">GLB materyallerini okur, gruplarƒ± olu≈üturur ve resim adlarƒ±nƒ± otomatik yazar.</p>
                            <button class="btn btn-primary" onclick="autoFill()">‚ö° GLB'den Gruplarƒ± Olu≈ütur</button>
                        </div>
                        <div id="v-container"></div>
                        <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="addGrp()">+ Manuel Grup Ekle</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="rp-header">‚ú® 3D Dedektifi</div>
            <div class="rp-content">
                <model-viewer id="viewer" camera-controls auto-rotate shadow-intensity="1" background-color="#1e293b" crossorigin="anonymous"></model-viewer>
                <div class="mat-list-title">MODEL MATERYALLERƒ∞</div>
                <div id="mat-list" class="mat-list"><div style="padding:15px; text-align:center; color:#64748b">Model Yok</div></div>
            </div>
        </div>
    </main>
    
    <script>
        // ==========================================
        // 1. AYARLAR VE DEƒûƒ∞≈ûKENLER
        // ==========================================
        let WORKER_URL = "https://plansmithco-adminpanel-api.serhatyildirim123.workers.dev"; 
        let R2_PUBLIC_URL = "https://pub-c09e063308e5459cb4c5727415475d43.r2.dev"; 

        let DATA=[], CAT=-1, PROD=-1, CRED={}, SHA="", R2_FILES=[], CUR_PATH="";
        let TARGET_ID=null, CHECKED_FILES=new Set(), LAST_INPUT=null, VIEW_MODE='list';

        // Sayfa Y√ºklendiƒüinde Token Kontrol√º
        window.onload = () => { 
            if(localStorage.getItem('gh_token')) {
                document.getElementById('gh-token').value = localStorage.getItem('gh_token'); 
            }
        }

        // ==========================================
        // 2. Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMLERƒ∞
        // ==========================================
        async function startLogin() {
            // URL Temizliƒüi
            if(WORKER_URL.endsWith('/list')) WORKER_URL = WORKER_URL.replace('/list', '');
            if(WORKER_URL.endsWith('/')) WORKER_URL = WORKER_URL.slice(0, -1);

            CRED = {
                token: document.getElementById('gh-token').value,
                owner: document.getElementById('gh-owner').value,
                repo: document.getElementById('gh-repo').value,
                branch: document.getElementById('gh-branch').value,
                path: document.getElementById('gh-path').value
            };

            if(!CRED.token) return alert("L√ºtfen Token Giriniz!");
            localStorage.setItem('gh_token', CRED.token);
            
            document.getElementById('loader').style.display='flex';

            try {
                // R2 Listesini √áek
                if(WORKER_URL) {
                    try {
                        const r = await fetch(WORKER_URL + "/list");
                        if(r.ok) R2_FILES = await r.json();
                    } catch(err) { console.warn("R2 Hatasƒ±:", err); }
                }

                // GitHub Verisini √áek
                const u = `https://api.github.com/repos/${CRED.owner}/${CRED.repo}/contents/${CRED.path}?ref=${CRED.branch}`;
                const res = await fetch(u, {headers:{'Authorization':`token ${CRED.token}`}});
                
                if(!res.ok) throw new Error("GitHub Hatasƒ±: " + res.status);
                
                const d = await res.json();
                SHA = d.sha;
                DATA = JSON.parse(decodeURIComponent(escape(window.atob(d.content))));
                
                document.getElementById('login-overlay').style.display='none';
                renderTree();

            } catch(e) { 
                alert("Giri≈ü Ba≈üarƒ±sƒ±z: " + e.message); 
            } finally { 
                document.getElementById('loader').style.display='none'; 
            }
        }

        // ==========================================
        // 3. DOSYA Y√ñNETƒ∞Cƒ∞Sƒ∞ (D√úZELTƒ∞LDƒ∞)
        // ==========================================
        function openFileManager() { TARGET_ID=null; openMedia(null, 'all'); } 

        function openMedia(id, type) {
            TARGET_ID = id; 
            CHECKED_FILES.clear(); 
            document.getElementById('media-modal').style.display='flex';
            CUR_PATH=""; 
            renderFiles(); 
            updateDelBtn();
        }

        function setViewMode(mode) {
            VIEW_MODE = mode;
            document.getElementById('mw-header').style.display = (mode === 'list') ? 'grid' : 'none';
            renderFiles();
        }

        function renderFiles() {
            const container = document.getElementById('mw-body');
            container.className = `mw-body view-${VIEW_MODE}`; 
            container.innerHTML='';
            document.getElementById('cur-path').innerText = CUR_PATH || "/ (Ana Dizin)";

            let items = [];
            const searchVal = document.getElementById('search-in').value.toLowerCase();
            const src = searchVal ? R2_FILES : R2_FILES.filter(f => f.key.startsWith(CUR_PATH));

            src.forEach(f => {
                const relative = f.key.slice(CUR_PATH.length);
                const parts = relative.split('/');
                if(searchVal) {
                    if(f.key.toLowerCase().includes(searchVal)) items.push({type:'file', key:f.key, name:f.key, size:f.size, date:f.uploaded});
                } else {
                    if(parts.length > 1 && parts[0]) {
                        if(!items.find(i=>i.name===parts[0] && i.type==='folder')) items.push({type:'folder', name:parts[0]});
                    } else if(parts.length === 1 && parts[0]!=='') {
                        items.push({type:'file', key:f.key, name:parts[0], size:f.size, date:f.uploaded});
                    }
                }
            });

            // Klas√∂rler √ústte
            items.sort((a,b) => (a.type==='folder'?-1:1));

            items.forEach(it => {
                const el = document.createElement('div'); el.className='file-item';
                // Benzersiz ID (Klas√∂rler i√ßin yol, dosyalar i√ßin key)
                const uniqueId = it.key || (CUR_PATH + it.name);
                
                if(CHECKED_FILES.has(uniqueId)) el.classList.add('selected-row');

                // --- CHECKBOX (ARTIK HERKES ƒ∞√áƒ∞N VAR) ---
                const chk = document.createElement('input'); 
                chk.type = 'checkbox'; 
                chk.className = 'file-check';
                chk.checked = CHECKED_FILES.has(uniqueId);
                
                // Tƒ±klama olayƒ±nƒ± satƒ±ra ge√ßirme
                chk.onclick = (e) => e.stopPropagation(); 
                
                chk.onchange = (e) => {
                    if(chk.checked) { 
                        CHECKED_FILES.add(uniqueId); 
                        el.classList.add('selected-row'); 
                    } else { 
                        CHECKED_FILES.delete(uniqueId); 
                        el.classList.remove('selected-row'); 
                    }
                    updateDelBtn(); // Butonu g√ºncelle
                };
                el.appendChild(chk);

                // --- ƒ∞KON & ƒ∞√áERƒ∞K ---
                if(it.type==='folder') el.classList.add('is-folder');
                
                let icon = it.type==='folder' ? '<div class="file-icon">üìÇ</div>' : '<div class="file-icon">üìÑ</div>';
                if(it.type==='file' && it.name.match(/\.(jpg|png|webp)$/i)) icon = `<img src="${WORKER_URL}/get/${it.key}" class="file-thumb">`;

                if(VIEW_MODE === 'list') {
                    const dateStr = it.date ? new Date(it.date).toLocaleDateString() : '-';
                    const sizeStr = it.size ? (it.size/1024).toFixed(1)+' KB' : '-';
                    el.innerHTML += `
                        <div class="file-info-grp">${icon} <span class="file-name">${it.name}</span></div>
                        <div class="file-meta">${dateStr}</div>
                        <div class="file-meta">${sizeStr}</div>
                    `;
                } else {
                    el.innerHTML += icon + `<div class="file-name">${it.name}</div>`;
                }
                
                // Satƒ±r Tƒ±klama (Gezinme veya Se√ßim)
                el.onclick = () => {
                    if(it.type==='folder') {
                        CUR_PATH += it.name + "/"; 
                        document.getElementById('search-in').value="";
                        renderFiles();
                    } else {
                        // Eƒüer input se√ßimi i√ßin a√ßƒ±ldƒ±ysa (TARGET_ID varsa)
                        if(TARGET_ID) { 
                            const val = "/" + it.key;
                            document.getElementById(TARGET_ID).value = val;
                            closeMedia();
                            if(TARGET_ID==='p-model') updateGlbPreview();
                            else document.getElementById(TARGET_ID).dispatchEvent(new Event('input'));
                        }
                    }
                };
                container.appendChild(el);
            });
        }

        // --- Sƒ∞LME BUTONU G√úNCELLEME ---
        function updateDelBtn() {
            const btn = document.getElementById('btn-delete');
            if(CHECKED_FILES.size > 0) { 
                btn.innerHTML = `üóëÔ∏è Sil (${CHECKED_FILES.size})`; 
                btn.style.opacity = '1'; 
                btn.style.pointerEvents = 'auto'; 
                btn.style.cursor = 'pointer';
            } else { 
                btn.innerHTML = `üóëÔ∏è Sil`; 
                btn.style.opacity = '0.5'; 
                btn.style.pointerEvents = 'none'; 
                btn.style.cursor = 'default';
            }
        }

        async function deleteSelectedFiles() {
            if(!confirm(`${CHECKED_FILES.size} √∂ƒüeyi silmek istediƒüinize emin misiniz?`)) return;
            
            document.getElementById('btn-delete').innerText = "Siliniyor...";
            
            for(const key of CHECKED_FILES) {
                try {
                    await fetch(WORKER_URL + "/delete/" + key, {method:'DELETE'});
                } catch(e) { console.error(e); }
            }
            
            // Yenile
            const r = await fetch(WORKER_URL+"/list"); 
            if(r.ok) R2_FILES = await r.json();
            
            CHECKED_FILES.clear(); 
            renderFiles(); 
            updateDelBtn();
        }
        
        async function uploadToR2(file) {
            if(!file || !WORKER_URL) return;
            const key = CUR_PATH + file.name;
            if(!confirm(`Y√ºklensin mi: ${file.name}`)) return;
            try {
                await fetch(WORKER_URL + "/upload/" + key, { method:"PUT", body:file });
                const r = await fetch(WORKER_URL+"/list"); 
                if(r.ok) R2_FILES = await r.json();
                renderFiles();
            } catch(e) { alert(e.message); }
        }

        function navUp() { if(!CUR_PATH)return; const p=CUR_PATH.split('/'); p.pop(); p.pop(); CUR_PATH=p.length>0?p.join('/')+"/":""; renderFiles(); }
        function closeMedia() { document.getElementById('media-modal').style.display='none'; }

        // ==========================================
        // 4. AƒûA√á VE √úR√úN Y√ñNETƒ∞Mƒ∞
        // ==========================================
        function renderTree() {
            const root = document.getElementById('tree-root'); root.innerHTML='';
            const sel = document.getElementById('p-cat'); sel.innerHTML='';
            DATA.forEach((c,i) => {
                sel.innerHTML += `<option value="${i}">${c.name}</option>`;
                const div = document.createElement('div'); div.className='tree-cat-group';
                div.innerHTML = `<div class="tree-cat-header" onclick="editCat(${i})">${c.name} ‚úé</div>`;
                c.products.forEach((p,j) => {
                    const item = document.createElement('div'); item.className='tree-item';
                    item.innerHTML = `üì¶ ${p.name||'Adsƒ±z'}`;
                    item.onclick = () => loadProd(i,j,item);
                    div.appendChild(item);
                });
                root.appendChild(div);
            });
        }

        function loadProd(i,j,el) {
            if(PROD>-1) saveMem();
            CAT=i; PROD=j;
            document.querySelectorAll('.tree-item').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('editor-area').classList.remove('hidden');
            
            const p = DATA[i].products[j];
            ['p-name','p-sku','p-thumb','p-desc','p-link','p-model'].forEach(k => document.getElementById(k).value = p[k.split('-')[1]] || '');
            document.getElementById('p-price').value = p.price || 0;
            document.getElementById('p-cat').value = i;
            renderVars(p.variantGroups||[]);
            updateGlbPreview();
        }

        // ==========================================
        // 5. VARYASYONLAR VE GLB (Oto Dolum Dahil)
        // ==========================================
        function updateGlbPreview() {
            const path = document.getElementById('p-model').value;
            const viewer = document.getElementById('viewer');
            const list = document.getElementById('mat-list');
            if(!path) { viewer.src=""; list.innerHTML=""; return; }
            
            const cleanPath = path.startsWith('/') ? path.slice(1) : path;
            viewer.src = WORKER_URL + "/get/" + cleanPath + "?t=" + new Date().getTime();

            viewer.addEventListener('load', () => {
                list.innerHTML = ''; window.MATS = [];
                if(viewer.model && viewer.model.materials) {
                    viewer.model.materials.forEach(m => {
                        window.MATS.push(m.name);
                        const el = document.createElement('div'); el.className='mat-item';
                        el.innerHTML = `<span>${m.name}</span> <span>‚û§</span>`;
                        el.onclick = () => { if(LAST_INPUT){LAST_INPUT.value=m.name; LAST_INPUT.dispatchEvent(new Event('input'));} };
                        list.appendChild(el);
                    });
                }
            }, {once:true});
        }

        function autoFill() {
            if(!window.MATS || window.MATS.length===0) return alert("√ñnce Model Y√ºkle!");
            if(!confirm("Otomatik gruplar olu≈üturulsun mu?")) return;
            const newGrps = [];
            window.MATS.forEach(m => {
                const autoName = m + "_baseColor.png"; 
                newGrps.push({
                    groupName: m, 
                    items: [{ name: "Orijinal", value: autoName, textureConfig: { materialName: m, baseColor: autoName } }]
                });
            });
            DATA[CAT].products[PROD].variantGroups = [...DATA[CAT].products[PROD].variantGroups, ...newGrps];
            renderVars(DATA[CAT].products[PROD].variantGroups);
        }

        function renderVars(grps) {
            const div = document.getElementById('v-container'); div.innerHTML='';
            grps.forEach((g,gi) => {
                const gDiv = document.createElement('div'); gDiv.className='v-group';
                let itemsHtml = '';
                g.items.forEach((it,ii) => {
                    itemsHtml += `
                    <div class="v-item">
                        <div><div class="v-item-label">Varyasyon Adƒ±</div><input value="${it.name}" oninput="updVar(${gi},${ii},'name',this.value)"></div>
                        <div><div class="v-item-label">Resim</div><div class="input-group-btn"><input value="${it.value}" id="vi-${gi}-${ii}" oninput="updVar(${gi},${ii},'value',this.value)"><button class="btn btn-primary" onclick="openMedia('vi-${gi}-${ii}','image')">..</button></div></div>
                        <div><div class="v-item-label">GLB Mat ID</div><input value="${it.textureConfig?.materialName||''}" onfocus="registerFocus(this)" oninput="updConf(${gi},${ii},'materialName',this.value)"></div>
                        <div><div class="v-item-label">Doku Dosyasƒ±</div><div class="input-group-btn"><input value="${it.textureConfig?.baseColor||''}" id="vt-${gi}-${ii}" oninput="updConf(${gi},${ii},'baseColor',this.value)"><button class="btn btn-primary" onclick="openMedia('vt-${gi}-${ii}','image')">..</button></div></div>
                        <button class="btn btn-danger" style="height:35px;" onclick="delItem(${gi},${ii})">X</button>
                    </div>`;
                });
                gDiv.innerHTML = `
                    <div class="v-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div style="display:flex; align-items:center;"><span style="margin-right:10px">‚ñº</span><input value="${g.groupName}" onclick="event.stopPropagation()" oninput="DATA[CAT].products[PROD].variantGroups[${gi}].groupName=this.value"></div>
                        <button class="btn btn-danger" onclick="delGrp(event, ${gi})">Sil</button>
                    </div>
                    <div class="v-body">${itemsHtml}<button class="btn btn-ghost" style="width:100%" onclick="addItem(${gi})">+ Ekle</button></div>`;
                div.appendChild(gDiv);
            });
        }

        // --- YARDIMCI FONKSƒ∞YONLAR ---
        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-'+t).classList.add('active');
        }
        function registerFocus(el) { LAST_INPUT=el; }
        function saveMem() { const p=DATA[CAT].products[PROD]; ['name','sku','thumb','desc','link','model'].forEach(k=>p[k]=document.getElementById('p-'+k).value); p.price=document.getElementById('p-price').value; }
        function editCat(i) { const n=prompt("Kategori Adƒ±nƒ± D√ºzenle:",DATA[i].name); if(n){ DATA[i].name=n; renderTree(); } }
        
        window.updVar=(g,i,k,v)=>DATA[CAT].products[PROD].variantGroups[g].items[i][k]=v;
        window.updConf=(g,i,k,v)=>{ if(!DATA[CAT].products[PROD].variantGroups[g].items[i].textureConfig)DATA[CAT].products[PROD].variantGroups[g].items[i].textureConfig={}; DATA[CAT].products[PROD].variantGroups[g].items[i].textureConfig[k]=v; }
        
        window.addGrp=()=>{ DATA[CAT].products[PROD].variantGroups.push({groupName:"Yeni Grup",items:[]}); renderVars(DATA[CAT].products[PROD].variantGroups); }
        window.addItem=(g)=>{ DATA[CAT].products[PROD].variantGroups[g].items.push({name:"Yeni",value:"",textureConfig:{}}); renderVars(DATA[CAT].products[PROD].variantGroups); }
        window.delGrp=(e,g)=>{ e.stopPropagation(); if(confirm("Grup silinsin mi?")) DATA[CAT].products[PROD].variantGroups.splice(g,1); renderVars(DATA[CAT].products[PROD].variantGroups); }
        window.delItem=(g,i)=>{ DATA[CAT].products[PROD].variantGroups[g].items.splice(i,1); renderVars(DATA[CAT].products[PROD].variantGroups); }
        
        async function saveGithub() { 
            if(PROD>-1) saveMem(); 
            document.getElementById('loader').style.display='flex'; 
            const u=`https://api.github.com/repos/${CRED.owner}/${CRED.repo}/contents/${CRED.path}`; 
            const b={message:"Upd v10.4", content:btoa(unescape(encodeURIComponent(JSON.stringify(DATA,null,2)))), sha:SHA, branch:CRED.branch}; 
            try{ 
                const r=await fetch(u,{method:'PUT', headers:{'Authorization':`token ${CRED.token}`}, body:JSON.stringify(b)}); 
                if(r.ok){ SHA=(await r.json()).content.sha; alert("Kaydedildi!"); } 
                else { alert("Kayƒ±t Hatasƒ±!"); }
            } catch(e){ alert(e.message); } 
            document.getElementById('loader').style.display='none'; 
        }
        
        window.newProd=()=>{ if(!DATA.length)return; if(CAT==-1)CAT=0; DATA[CAT].products.push({name:"Yeni", variantGroups:[]}); renderTree(); }
        window.newCat=()=>{ const n=prompt("Ad"); if(n)DATA.push({name:n, products:[]}); renderTree(); }
        
        window.delProd=()=>{ 
            if(confirm("Sil?")){ 
                DATA[CAT].products.splice(PROD,1); 
                document.getElementById('editor-area').classList.add('hidden'); 
                renderTree(); 
            } 
        }
        window.moveCat=()=>{ const n=document.getElementById('p-cat').value; saveMem(); const p=DATA[CAT].products.splice(PROD,1)[0]; DATA[n].products.push(p); renderTree(); }
    </script>
</body>
</html>