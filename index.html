<!doctype html>
<html lang="en">
  <head>
    <title>AR Viewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { margin: 0; background-color: #f0f0f0; font-family: sans-serif; height: 100vh; overflow: hidden; }
      model-viewer { width: 100%; height: 100%; }
      
      /* Hata Mesajı Kutusu */
      #error-box {
        display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        text-align: center; max-width: 80%; z-index: 999;
      }
      #error-box h3 { color: red; margin-top: 0; }

      /* AR Butonu */
      #ar-btn {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        padding: 12px 24px; background: #000; color: #fff; border-radius: 30px;
        border: none; font-weight: bold; font-size: 16px; cursor: pointer; z-index: 100;
        display: none; /* JS ile açılacak */
      }
    </style>
  </head>
  <body>

    <div id="error-box">
      <h3>HATA</h3>
      <p id="error-msg">Bir sorun oluştu.</p>
    </div>

    <model-viewer id="mv"
      ar ar-modes="webxr scene-viewer quick-look"
      camera-controls tone-mapping="neutral" shadow-intensity="1">
    </model-viewer>

    <button id="ar-btn">AR ile Görüntüle</button>

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    
    <script>
      const mv = document.getElementById('mv');
      const errorBox = document.getElementById('error-box');
      const errorMsg = document.getElementById('error-msg');
      const arBtn = document.getElementById('ar-btn');

      // Hata gösterme fonksiyonu
      function showError(msg) {
        errorBox.style.display = 'block';
        errorMsg.textContent = msg;
        console.error(msg);
      }

      // 1. DOKU DEĞİŞTİRME MANTIĞI
      async function applyTexture(textureKey) {
        if(!textureKey) return;
        try {
          console.log("Doku yükleniyor:", textureKey);
          // Texture'ı proxy üzerinden çek
          const textureUrl = `/file/${encodeURIComponent(textureKey)}`;
          const texture = await mv.createTexture(textureUrl);
          
          // İlk materyali bul ve değiştir
          const material = mv.model.materials[0];
          if (material) {
            material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
            console.log("Doku uygulandı.");
          }
        } catch (e) {
          console.warn("Doku hatası:", e);
        }
      }

      // 2. ANA YÜKLEME AKIŞI
      async function init() {
        const url = new URL(window.location.href);
        
        // SKU'yu URL'den söküp al (hem /m/SKU hem ?sku=SKU destekler)
        let sku = url.searchParams.get('sku');
        const pathMatch = url.pathname.match(/\/m\/([^\/]+)/);
        if (pathMatch) sku = pathMatch[1];

        if (!sku) {
          // Varsayılan SBRV2'yi BURADA bilerek yüklüyoruz ki test edebilesin.
          // İstemiyorsan burayı silip showError("SKU bulunamadı") yazabilirsin.
          sku = 'SBRV2'; 
          console.log("SKU belirtilmedi, varsayılan (SBRV2) kullanılıyor.");
        }

        console.log("İstenen SKU:", sku);

        try {
          // API'ye sor
          const res = await fetch(`/api/resolve?sku=${encodeURIComponent(sku)}`);
          
          if (!res.ok) {
            throw new Error(`API Hatası: ${res.status} (Model veritabanında yok)`);
          }

          const data = await res.json();
          if (!data.key) throw new Error("API geçerli bir key döndürmedi.");

          // Modeli Yükle
          const fileUrl = `/file/${encodeURIComponent(data.key)}`;
          mv.src = fileUrl;
          
          // Global değişken (Android AR için)
          window.arFileUrl = new URL(fileUrl, window.location.origin).href;
          
          // Butonu göster
          arBtn.style.display = 'block';

          // Texture varsa uygula (?tex=mese.jpg)
          const tex = url.searchParams.get('tex');
          if (tex) {
            mv.addEventListener('load', () => applyTexture(tex), { once: true });
          }

        } catch (err) {
          showError(err.message);
        }
      }

      // 3. AR BUTON MANTIĞI
      arBtn.addEventListener('click', () => {
        if (mv.canActivateAR) {
          mv.activateAR();
        } else if (window.arFileUrl) {
          const intent = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(window.arFileUrl)}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;
          window.location.href = intent;
        } else {
          alert("AR bu cihazda desteklenmiyor.");
        }
      });

      init();
    </script>
  </body>
</html>