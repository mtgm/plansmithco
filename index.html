<!doctype html>
<html lang="en">
  <head>
    <title>AR Viewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { margin: 0; background-color: #f5f5f5; font-family: sans-serif; height: 100vh; overflow: hidden; }
      model-viewer { width: 100%; height: 100%; }
      #error-toast { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #d32f2f; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; z-index: 9999; }
      #ar-btn { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: #111; color: #fff; border-radius: 30px; border: none; font-weight: 600; cursor: pointer; z-index: 100; }
    </style>
  </head>
  <body>

    <div id="error-toast"></div>
    
    <model-viewer id="mv" ar ar-modes="webxr scene-viewer quick-look" camera-controls tone-mapping="neutral" shadow-intensity="1"></model-viewer>

    <button id="ar-btn">Mekanımda Gör</button>

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    
    <script>
      const mv = document.getElementById('mv');
      const errorToast = document.getElementById('error-toast');
      const arBtn = document.getElementById('ar-btn');

      function showError(msg) {
        errorToast.textContent = msg;
        errorToast.style.display = 'block';
        console.error(msg);
      }

      // --- TEXTURE AYARI ---
      async function applyTexture(textureKey) {
        if (!textureKey) return;
        try {
          // Texture dosyasını proxy üzerinden çek
          const textureUrl = `/api/glb?key=${encodeURIComponent(textureKey)}`;
          const texture = await mv.createTexture(textureUrl);
          const material = mv.model.materials[0];
          if (material) material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
        } catch (e) { console.warn("Doku hatası:", e); }
      }

      // --- ANA MANTIK ---
      async function init() {
        const url = new URL(window.location.href);
        
        // SKU Çözümleme (/m/SKU veya ?sku=SKU)
        let sku = url.searchParams.get('sku');
        const pathMatch = url.pathname.match(/\/m\/([^\/]+)/);
        if (pathMatch) sku = pathMatch[1];

        if (!sku) return showError("SKU eksik!");
        sku = sku.toUpperCase();

        try {
          // ÖNEMLİ: models.json dosyasını tarayıcıdan çekiyoruz.
          // ?t=... parametresi "cache" (önbellek) sorununu engeller, her zaman en yeniyi çeker.
          const dbRes = await fetch(`/models.json?t=${Date.now()}`);
          
          if (!dbRes.ok) throw new Error("Veritabanı dosyası (models.json) okunamadı.");
          
          const db = await dbRes.json();
          const modelKey = db[sku]; // JSON içinden dosya adını bul

          if (!modelKey) throw new Error(`Model bulunamadı: ${sku}`);

          // R2 Proxy Bağlantısı
          const fileUrl = `/api/glb?key=${encodeURIComponent(modelKey)}`;
          
          mv.src = fileUrl;
          window.arFileUrl = new URL(fileUrl, window.location.origin).href; // Android AR için
          arBtn.style.display = 'block';

          // Texture varsa uygula
          const tex = url.searchParams.get('tex');
          if (tex) {
             mv.addEventListener('load', () => applyTexture(tex), { once: true });
          }

        } catch (err) {
          showError(err.message);
        }
      }

      arBtn.addEventListener('click', () => {
        if (mv.canActivateAR) mv.activateAR();
        else if (window.arFileUrl) location.href = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(window.arFileUrl)}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;
        else alert("AR desteklenmiyor.");
      });

      init();
    </script>
  </body>
</html>