<!doctype html>
<html lang="en">
  <head>
    <title>PlanSmithCo | AR Model Viewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/styles.css">

    <style>
      html,body{height:100%;margin:0;background:#fff;overflow:hidden}
      model-viewer{width:100vw;height:100vh;--poster-color:transparent}
      #brand{position:fixed;left:12px;bottom:12px;font:600 12px/1 ui-sans-serif,system-ui;opacity:.6;z-index:40}

      /* Tek butonumuz */
      .psco-ar-btn{
        position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
        padding:10px 16px;border:0;border-radius:12px;background:#111;color:#fff;
        font:600 14px ui-sans-serif,system-ui;box-shadow:0 6px 20px rgba(0,0,0,.25);
        z-index:50;cursor:pointer;
      }
    </style>
  </head>
  <body>
    <model-viewer id="mv"
      ar
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      tone-mapping="neutral"
      poster="/poster.webp"
      shadow-intensity="0.45"
      shadow-softness="0.95"
      camera-orbit="0deg 75deg auto"
      field-of-view="45deg"
      min-field-of-view="15deg"
      max-field-of-view="75deg"
      exposure="1.2">
      <div class="progress-bar hide" slot="progress-bar">
        <div class="update-bar"></div>
      </div>
      <div id="ar-prompt"><img src="/ar_hand_prompt.png" alt=""></div>
    </model-viewer>

    <!-- sadece bizim sabit butonumuz -->
    <button id="open-ar" class="psco-ar-btn" type="button">View in your space</button>
    <div id="brand">@PlanSmithCo</div>

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

    <script>
      (async () => {
        try {
          const mv = document.getElementById('mv');
          if (!mv) return;

          const url = new URL(location.href);
          const m = url.pathname.match(/^\/m\/([^\/#?]+)/);
          const skuFromPath = m ? m[1] : null;
          const qs = new URLSearchParams(url.search);
          const sku = skuFromPath || qs.get('sku') || 'SBRV2';

          // API'den model anahtarını al
          let key = qs.get('key');
          if (!key) {
            const res = await fetch(`/api/resolve?sku=${encodeURIComponent(sku)}`);
            const json = await res.json();
            if (json && json.ok && json.key) key = json.key;
          }

          // yedek
          key = key || 'SBR-v2.glb';

          const fileUrl = `/file/${encodeURIComponent(key)}`;
          const ABS_FILE_URL = new URL(fileUrl, location.origin).href;
          window.ABS_FILE_URL = ABS_FILE_URL;

          mv.src = fileUrl;
        } catch (err) {
          console.error('Fatal viewer error:', err);
        }
      })();

      // AR açma fonksiyonu (tek buton)
      async function openAR() {
        const mv = document.getElementById('mv');
        try {
          if (mv && mv.canActivateAR && typeof mv.activateAR === 'function') {
            await mv.activateAR(); // Model-Viewer destekliyse doğrudan açar
            return;
          }

          // Android fallback (Scene Viewer)
          if (window.ABS_FILE_URL) {
            const title = 'PlanSmithCo';
            const intent =
              `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(window.ABS_FILE_URL)}&mode=ar_preferred&title=${encodeURIComponent(title)}` +
              `#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;
            location.href = intent;
          }
        } catch (e) {
          console.error('AR açılamadı:', e);
        }
      }
      document.getElementById('open-ar')?.addEventListener('click', openAR);
    </script>

    <script src="/script.js"></script>
  </body>
</html>
