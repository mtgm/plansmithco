<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>PlanSmithCo v15.2 (Ultimate)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <style>
        /* --- 1. RENK PALETƒ∞ VE CAM EFEKTƒ∞ (PROFESYONEL) --- */
        :root {
            /* Marka Renkleri */
            --primary: #EAB308; /* Sarƒ±/Altƒ±n */
            --primary-hover: #CA8A04; 
            --secondary: #1E293B; /* Derin Lacivert */
            --secondary-light: #334155; 
            
            /* Durum Renkleri */
            --danger: #ef4444; 
            --success: #10b981; 
            --warning: #f59e0b;

            /* Arka Plan ve Cam */
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --glass-bg-dark: rgba(15, 23, 42, 0.7); 
            --glass-bg-light: rgba(255, 255, 255, 0.95); 
            --glass-border: rgba(255, 255, 255, 0.1); 
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --backdrop-blur: blur(12px);
            
            /* Metin */
            --text-on-dark: #f1f5f9; 
            --text-on-light: #0f172a; 
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; outline: none; }
        
        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient); 
            color: var(--text-on-dark); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-size: 13px; 
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* --- 2. LAYOUT --- */
        aside { 
            width: 280px; 
            background: var(--glass-bg-dark);
            backdrop-filter: var(--backdrop-blur);
            border-right: 1px solid var(--glass-border); 
            display: flex; flex-direction: column; z-index: 10; 
        }

        main { flex: 1; display: flex; overflow: hidden; position: relative; }

        .center-panel { 
            flex: 1; display: flex; flex-direction: column; overflow: hidden; 
            background: var(--glass-bg-light); /* ƒ∞√ßerik i√ßin net zemin */
            backdrop-filter: var(--backdrop-blur);
            border-radius: 16px 0 0 16px; 
            margin: 10px 0 10px 10px; 
            box-shadow: -5px 0 20px rgba(0,0,0,0.2); 
            position: relative; z-index: 5;
            color: var(--text-on-light); 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .editor-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 25px; }

        .right-panel { 
            width: 360px; 
            background: var(--glass-bg-dark); 
            backdrop-filter: var(--backdrop-blur);
            border-left: 1px solid var(--glass-border); 
            display: flex; flex-direction: column; z-index: 6; 
        }

        /* --- 3. SOL PANEL (SIDEBAR) --- */
        .brand { 
            padding: 25px; font-weight: 800; font-size: 22px; letter-spacing: -0.5px;
            border-bottom: 1px solid var(--glass-border); 
            background: linear-gradient(to right, var(--primary), #FCD34D);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 15px rgba(234, 179, 8, 0.2);
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .brand span { background: linear-gradient(to right, var(--primary), #FCD34D); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-btn { 
            background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3);
            padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;
            transition: all 0.2s; opacity: 0.6;
        }
        .logo-btn:hover { opacity: 1; background: rgba(255,255,255,0.2); }
        
        .tree-view { flex: 1; padding: 15px; overflow-y: auto; }
        
        .tree-cat-group { margin-bottom: 12px; }
        .tree-cat-header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; font-weight: 700; font-size: 11px; 
            text-transform: uppercase; color: #94a3b8; cursor:pointer; 
            transition: color 0.2s;
        }
        .tree-cat-header:hover { color: #fff; }
        
        /* Kategori header d√ºzeni */
        .tree-cat-header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; font-weight: 700; font-size: 11px; 
            text-transform: uppercase; color: #94a3b8; cursor:pointer; 
            transition: color 0.2s;
        }
        .cat-name { cursor: pointer; flex: 1; }
        .cat-name:hover { color: var(--primary); }
        .cat-actions { display: flex; gap: 8px; align-items: center; }
        .cat-btn { cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: all 0.2s; font-size: 12px; }
        .cat-add { color: var(--success); font-weight: bold; font-size: 16px; }
        .cat-add:hover { background: rgba(16, 185, 129, 0.2); }
        .cat-del { color: var(--danger); font-size: 12px; }
        .cat-del:hover { background: rgba(239, 68, 68, 0.2); }
        
        /* √úr√ºn item d√ºzeni */
        .tree-item { 
            padding: 10px 14px; cursor: pointer; font-size: 13px; 
            border-radius: 8px; margin-top: 4px; font-weight: 500; 
            display: flex; align-items: center; justify-content: space-between; color: #cbd5e1;
            transition: all 0.2s ease; border: 1px solid transparent;
        }
        .prod-name { flex: 1; cursor: pointer; }
        .prod-del { opacity: 0; color: var(--danger); cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: all 0.2s; font-size: 12px; }
        .tree-item:hover .prod-del { opacity: 1; }
        .prod-del:hover { background: rgba(239, 68, 68, 0.2); }
        
        /* Inline d√ºzenleme input */
        .inline-edit {
            background: rgba(255,255,255,0.15);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 4px 8px;
            color: #fff;
            font-size: 12px;
            width: 120px;
            outline: none;
        }
        .inline-edit:focus {
            box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.3);
        }

        .tree-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .tree-item.active { 
            background: rgba(234, 179, 8, 0.15); color: var(--primary); 
            font-weight: 600; border-color: rgba(234, 179, 8, 0.3);
        }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 10px; }

        /* --- 4. DOSYA Y√ñNETƒ∞Cƒ∞Sƒ∞ (MODAL) --- */
        #media-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(8px); z-index: 1000; display: none; 
            align-items: center; justify-content: center; 
        }
        .media-window { 
            width: 85%; height: 85%; background: #ffffff; 
            border-radius: 12px; display: flex; flex-direction: column; 
            overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5); 
            color: var(--text-on-light);
        }
        .mw-toolbar { padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 12px; align-items: center; background: #f8fafc; }
        .mw-address { padding: 8px 20px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-muted); }
        .mw-header { display: grid; grid-template-columns: 30px 40px 1fr 120px 80px 40px 40px; padding: 12px 20px; border-bottom: 1px solid #e2e8f0; background: #f1f5f9; font-weight: 600; color: var(--text-muted); font-size: 11px; gap: 10px; align-items: center; }
        .mw-body { flex: 1; overflow-y: auto; padding: 10px 20px; background: #fff; }

        /* Liste G√∂r√ºn√ºm√º */
        .view-list .file-item { display: grid; grid-template-columns: 30px 50px 1fr 120px 80px 40px 40px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer; align-items: center; gap: 10px; transition: background 0.1s; color: var(--text-on-light); }
        .view-list .file-item:hover { background: #f8fafc; }
        .view-list .file-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        .view-list .file-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Izgara G√∂r√ºn√ºm√º */
        .view-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; padding: 15px; align-content: start; }
        .view-grid .file-item { display: flex; flex-direction: column; align-items: center; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 8px; cursor: pointer; height: 160px; position: relative; background: #fff; transition: all 0.2s; }
        .view-grid .file-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .view-grid .file-thumb { width: 60px; height: 60px; object-fit: contain; margin-bottom: 8px; }
        .view-grid .file-name { font-size: 11px; text-align: center; font-weight: 500; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 4px; }
        .view-grid .item-check { position: absolute; top: 8px; left: 8px; transform: scale(1.1); }
        .view-grid .grid-actions { display: flex; gap: 4px; width: 100%; justify-content: center; margin-top: auto; }

        .selected-row { background: #fffbeb !important; border-color: #fcd34d !important; }
        .item-check { cursor: pointer; accent-color: var(--primary); }

        /* --- 5. Bƒ∞LE≈ûENLER --- */
        input, select, textarea { 
            width: 100%; padding: 10px 12px; 
            border: 1px solid #cbd5e1; background: rgba(255,255,255,0.8);
            border-radius: 8px; font-family: inherit; font-size: 13px; color: var(--text-on-light);
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15); background: #fff; }
        label { font-weight: 600; color: var(--secondary); font-size: 12px; margin-bottom: 6px; display: block; }

        .btn { padding: 9px 18px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn:hover { transform: translateY(-1px); opacity: 0.95; }
        .btn-primary { background: var(--primary); color: var(--secondary); }
        .btn-danger { background: #fff; color: var(--danger); border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: var(--secondary); }
        .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: inherit; }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        .action-btn { width: 32px; height: 32px; border-radius: 6px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: var(--text-muted); }
        .action-btn:hover { background: #f1f5f9; color: var(--primary); }
        .btn-del:hover { background: #fee2e2; color: var(--danger); }

        .tabs-header { display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; gap: 20px; flex-shrink: 0; }
        .tab-btn { padding: 10px 5px; cursor: pointer; font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 6. VARYASYON GRUPLARI --- */
        .v-group { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .v-header { background: #f8fafc; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; cursor: pointer; }
        .v-header input { border-color: transparent; background: transparent; font-weight: 700; width: auto; color: var(--secondary); }
        .v-header input:hover { background: #fff; border-color: #cbd5e1; }
        .v-body { padding: 20px; }
        
        .arrow { display: inline-block; transition: transform 0.2s ease; margin-right: 10px; font-size: 10px; color: var(--text-muted); }
        .v-group.collapsed .arrow { transform: rotate(-90deg); }
        .v-group.collapsed .v-body { display: none; }

        .v-item { display: grid; grid-template-columns: 25px 1.5fr 1.5fr 1fr 1.5fr 40px; gap: 12px; align-items: end; background: #fff; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; }
        .v-item-label { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }

        /* --- 7. PRO SAƒû PANEL --- */
        .rp-header { padding: 15px; border-bottom: 1px solid var(--glass-border); font-weight: 700; background: rgba(0,0,0,0.2); color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .rp-content { padding: 20px; overflow-y: auto; flex: 1; }
        
        model-viewer#viewer { width: 100%; height: 260px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border); }
        
        .mat-list-title { font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .mat-list { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 12px; overflow: hidden; }
        .mat-item { padding: 12px 16px; border-bottom: 1px solid var(--glass-border); cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; color: #f1f5f9; transition: all 0.2s ease; }
        .mat-item:last-child { border-bottom: none; }
        .mat-item:hover { background-color: var(--primary) !important; color: var(--secondary) !important; padding-left: 22px !important; }

        /* --- 8. LOADER & LOGIN --- */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #cbd5e1; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* Custom Modal */
        .custom-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .custom-modal.active { display: flex; }
        .custom-modal-content {
            background: #fff; border-radius: 16px; width: 400px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3); overflow: hidden;
            animation: modalSlide 0.2s ease;
        }
        @keyframes modalSlide { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .custom-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, var(--primary) 0%, #FCD34D 100%);
        }
        .custom-modal-header h3 { margin: 0; color: var(--secondary); font-size: 16px; }
        .modal-close { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--secondary); opacity: 0.7; }
        .modal-close:hover { opacity: 1; }
        .custom-modal-body { padding: 24px; }
        .custom-modal-body label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary); }
        .custom-modal-body input { 
            width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; 
            border-radius: 8px; font-size: 14px; transition: all 0.2s;
        }
        .custom-modal-body input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15); outline: none; }
        .custom-modal-footer { padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc; }
        
        /* Varyasyon Checkbox Stilleri */
        .v-group-check, .v-item-check { 
            width: 18px; height: 18px; cursor: pointer; 
            accent-color: var(--primary); flex-shrink: 0;
        }
        .v-batch-actions {
            display: flex; gap: 10px; align-items: center; margin-bottom: 15px;
            padding: 10px 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .v-batch-actions.hidden { display: none; }
        .v-batch-count { font-size: 13px; color: var(--text-muted); }
        .v-item-batch-actions {
            display: flex; gap: 8px; align-items: center; margin-top: 10px;
            padding: 8px 12px; background: #fef3c7; border-radius: 6px;
        }
        .v-item-batch-actions.hidden { display: none; }
        
        #login-overlay { position: fixed; inset: 0; background: var(--bg-gradient); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 50px; border-radius: 24px; width: 420px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .login-logo { font-size: 28px; font-weight: 800; background: linear-gradient(to right, var(--primary), #FCD34D); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .hidden { display: none !important; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full { grid-column: span 2; }
        .input-group-btn { display: flex; gap: 8px; }
    </style>
</head>
<body>

    <div id="media-modal">
        <div class="media-window">
            <div class="mw-toolbar">
                <button class="btn btn-primary" onclick="document.getElementById('r2-up').click()">‚òÅÔ∏è Y√ºkle</button>
                <input type="file" id="r2-up" hidden onchange="uploadToR2(this.files[0])">
                <button class="btn btn-success" onclick="createNewFolder()">+ üìÅ Klas√∂r</button>
                <button class="btn btn-danger" id="btn-batch-delete" style="opacity:0.5; pointer-events:none;" onclick="deleteBatch()">üóëÔ∏è Sil</button>
                <button class="btn btn-primary" id="btn-copy" style="display:none;" onclick="copySelected()">üìã Kopyala</button>
                <button class="btn btn-warning" id="btn-move" style="display:none;" onclick="moveSelected()">‚úÇÔ∏è Ta≈üƒ±</button>
                <button class="btn btn-success" id="btn-paste" style="display:none;" onclick="pasteFiles()">üìã Yapƒ±≈ütƒ±r</button>
                <div style="flex:1"></div>
                <button class="btn btn-ghost" onclick="setViewMode('list')">‚ò∞</button>
                <button class="btn btn-ghost" onclick="setViewMode('grid')">‚ñ¶</button>
                <input type="text" placeholder="Ara..." id="search-in" style="width: 200px;" oninput="renderFiles()">
                <button class="btn btn-ghost" style="color:var(--danger); border-color:var(--danger);" onclick="closeMedia()">‚úï</button>
            </div>
            <div class="mw-address">
                <button class="btn btn-ghost" style="padding:4px 10px; font-size:11px;" onclick="navUp()">‚¨Ü √úst</button>
                <span id="cur-path" style="font-family:monospace; font-weight:bold; color:var(--secondary);">/</span>
            </div>
            <div id="mw-header" class="mw-header">
                <input type="checkbox" id="master-check" class="item-check" onchange="toggleSelectAll(this)">
                <div>Tip</div> <div>Dosya Adƒ±</div> <div>Tarih</div> <div>Boyut</div> <div>D√ºzenle</div> <div>Sil</div>
            </div>
            <div class="mw-body" id="mw-body"></div>
        </div>
    </div>

    <!-- Yeni Kategori Modal -->
    <div id="cat-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3>‚ûï Yeni Kategori Olu≈ütur</h3>
                <button class="modal-close" onclick="closeCatModal()">‚úï</button>
            </div>
            <div class="custom-modal-body">
                <label>Kategori Adƒ±</label>
                <input type="text" id="new-cat-name" placeholder="Kategori adƒ±nƒ± girin..." autofocus>
            </div>
            <div class="custom-modal-footer">
                <button class="btn btn-ghost" onclick="closeCatModal()">ƒ∞ptal</button>
                <button class="btn btn-success" onclick="confirmNewCat()">Olu≈ütur</button>
            </div>
        </div>
    </div>

    <!-- Genel Onay Modal -->
    <div id="confirm-modal" class="custom-modal">
        <div class="custom-modal-content" style="width:380px;">
            <div class="custom-modal-header" id="confirm-header">
                <h3 id="confirm-title">‚ö†Ô∏è Onay</h3>
                <button class="modal-close" onclick="closeConfirmModal(false)">‚úï</button>
            </div>
            <div class="custom-modal-body">
                <p id="confirm-message" style="margin:0; color:var(--secondary); line-height:1.6;"></p>
            </div>
            <div class="custom-modal-footer">
                <button class="btn btn-ghost" onclick="closeConfirmModal(false)">ƒ∞ptal</button>
                <button class="btn btn-danger" id="confirm-btn" onclick="closeConfirmModal(true)">Onayla</button>
            </div>
        </div>
    </div>

    <!-- Genel Bilgi Modal (Alert yerine) -->
    <div id="alert-modal" class="custom-modal">
        <div class="custom-modal-content" style="width:360px;">
            <div class="custom-modal-header" id="alert-header">
                <h3 id="alert-title">‚ÑπÔ∏è Bilgi</h3>
                <button class="modal-close" onclick="closeAlertModal()">‚úï</button>
            </div>
            <div class="custom-modal-body">
                <p id="alert-message" style="margin:0; color:var(--secondary); line-height:1.6;"></p>
            </div>
            <div class="custom-modal-footer">
                <button class="btn btn-primary" onclick="closeAlertModal()">Tamam</button>
            </div>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div></div>
    <div id="login-overlay">
        <div class="login-box">
            <div class="login-logo">PlanSmithCo.</div>
            <p style="color:#64748b; margin-bottom:30px;">Build it smart</p>
            <input type="password" id="gh-token" placeholder="GitHub Token" style="margin-bottom:15px; background:#f1f5f9;">
            <input type="text" id="gh-owner" placeholder="User" value="mtgm" style="margin-bottom:15px; background:#f1f5f9;">
            <input type="text" id="gh-repo" placeholder="Repo" value="plansmithco" style="margin-bottom:15px; background:#f1f5f9;">
            <input type="text" id="gh-branch" placeholder="Branch" value="v2-showroom" style="margin-bottom:15px; background:#f1f5f9;">
            <input type="text" id="gh-path" placeholder="File" value="products.json" style="margin-bottom:30px; background:#f1f5f9;">
            <button class="btn btn-primary" style="width:100%; padding:14px; font-size:14px;" onclick="startLogin()">Giri≈ü Yap</button>
        </div>
    </div>

    <aside>
        <div class="brand">
            <span>üöÄ PlanSmithCo.</span>
            <img id="brand-logo" src="" alt="" style="display:none; height:28px; border-radius:4px;" onclick="changeLogo()">
            <button class="logo-btn" onclick="changeLogo()" title="Logo Ekle/Deƒüi≈ütir">üñºÔ∏è</button>
        </div>
        <div class="tree-view" id="tree-root"></div>
        <div class="sidebar-footer">
            <button class="btn btn-ghost" style="width:100%; color:#e2e8f0; border-color:rgba(255,255,255,0.2);" onclick="openFileManager()">üìÇ R2 Dosya Y√∂neticisi</button>
            <button class="btn btn-warning" style="width:100%" onclick="newCat()">+ Yeni Kategori</button>
            <button class="btn btn-success" style="width:100%" onclick="saveGithub()">üíæ GitHub'a Kaydet</button>
        </div>
    </aside>

    <main>
        <div class="center-panel">
            <div id="editor-area" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                <div class="tabs-header">
                    <div class="tab-btn active" onclick="switchTab('genel')">Genel Bilgiler</div>
                    <div class="tab-btn" onclick="switchTab('varyasyon')">Varyasyonlar & Konfig√ºrasyon</div>
                </div>

                <div class="editor-content">
                    <div id="tab-genel" class="tab-content active">
                        <div class="card">
                            <div class="form-grid">
                                <div class="full"><label>Kategori</label><select id="p-cat" onchange="moveCat()"></select></div>
                                <div><label>√úr√ºn Adƒ±</label><input id="p-name" oninput="updateProdNameInTree()"></div>
                                <div><label>SKU</label><input id="p-sku"></div>
                                <div><label>Fiyat</label><input type="number" id="p-price"></div>
                                <div>
                                    <label>Poster</label>
                                    <div class="input-group-btn">
                                        <input id="p-thumb"><button class="btn btn-primary" onclick="openMedia('p-thumb','image')">Se√ß</button>
                                    </div>
                                </div>
                                <div class="full"><label>A√ßƒ±klama</label><textarea id="p-desc" rows="4"></textarea></div>
                                <div class="full"><label>Etsy Linki</label><input id="p-link"></div>
                                <div class="full">
                                    <label>Model Dosyasƒ± (.glb)</label>
                                    <div class="input-group-btn">
                                        <input id="p-model" onchange="localGlbUrl=null; updateGlbPreview()">
                                        <button class="btn btn-primary" onclick="openMedia('p-model','model')" title="R2'den Se√ß">üìÇ</button>
                                        <button class="btn btn-success" onclick="selectLocalGlb()" title="Bilgisayardan Y√ºkle">üíª</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-varyasyon" class="tab-content">
                        <div style="background:rgba(234, 179, 8, 0.1); padding:20px; border-radius:12px; margin-bottom:25px; text-align:center; border:1px dashed var(--primary);">
                            <h4 style="margin:0 0 8px 0; color:var(--primary);">Otomatik Varyasyon Sihirbazƒ±</h4>
                            <p style="font-size:12px; margin-bottom:15px; color:var(--text-muted);">GLB dosyasƒ±ndaki materyalleri analiz eder ve gruplarƒ± otomatik olu≈üturur.</p>
                            <button class="btn btn-primary" onclick="autoFill()">‚ö° GLB'den Gruplarƒ± Olu≈ütur</button>
                        </div>
                        <div id="v-container"></div>
                        <button class="btn btn-ghost" style="width:100%; margin-top:15px; border-style:dashed; border-color:#cbd5e1; color:var(--text-muted);" onclick="addGrp()">+ Manuel Grup Ekle</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="rp-header" style="justify-content:center;">‚ú® 3D Dedektifi</div>
            <div class="rp-content">
                <model-viewer id="viewer" camera-controls shadow-intensity="1" background-color="#1e293b" crossorigin="anonymous"></model-viewer>
                <div class="mat-list-title">MODEL MATERYALLERƒ∞</div>
                <div id="mat-list" class="mat-list"><div style="padding:15px; text-align:center; color:#94a3b8; font-size:12px;">Model Se√ßilmedi</div></div>
            </div>
        </div>
    </main>

    <script>
        // AYARLAR & DEƒûƒ∞≈ûKENLER
        let WORKER_URL = "https://plansmithco-adminpanel-api.serhatyildirim123.workers.dev"; 
        let R2_PUBLIC_URL = "https://pub-c09e063308e5459cb4c5727415475d43.r2.dev"; 
        let DATA=[], CAT=-1, PROD=-1, CRED={}, SHA="", R2_FILES=[], CUR_PATH="";
        let TARGET_ID=null, LAST_INPUT=null, VIEW_MODE='list';
        let CHECKED_FILES = new Set(), CLIPBOARD = [], CLIPBOARD_ACTION = 'copy'; 
        let MATS = []; // Global MATS Dizisi (HATA D√úZELTƒ∞LDƒ∞)
        let hasUnsavedChanges = false; // Kaydedilmemi≈ü deƒüi≈üiklik var mƒ±?
        let confirmCallback = null; // Confirm modal callback
        let alertCallback = null; // Alert modal callback

        // Custom Confirm Modal (pop-up yerine)
        function showConfirm(title, message, onConfirm, btnText = 'Onayla', type = 'danger') {
            document.getElementById('confirm-title').innerHTML = title;
            document.getElementById('confirm-message').innerHTML = message;
            document.getElementById('confirm-btn').textContent = btnText;
            document.getElementById('confirm-btn').className = `btn btn-${type}`;
            
            // Header rengini tipe g√∂re ayarla
            const header = document.getElementById('confirm-header');
            if(type === 'danger') {
                header.style.background = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
                header.querySelector('h3').style.color = '#fff';
            } else if(type === 'success') {
                header.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                header.querySelector('h3').style.color = '#fff';
            } else {
                header.style.background = 'linear-gradient(135deg, var(--primary) 0%, #FCD34D 100%)';
                header.querySelector('h3').style.color = 'var(--secondary)';
            }
            
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').classList.add('active');
        }
        
        function closeConfirmModal(confirmed) {
            document.getElementById('confirm-modal').classList.remove('active');
            if(confirmed && confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
        }
        
        // Custom Alert Modal (alert yerine)
        function showAlert(title, message, type = 'info', onClose = null) {
            document.getElementById('alert-title').innerHTML = title;
            document.getElementById('alert-message').innerHTML = message;
            
            const header = document.getElementById('alert-header');
            if(type === 'success') {
                header.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                header.querySelector('h3').style.color = '#fff';
            } else if(type === 'error') {
                header.style.background = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
                header.querySelector('h3').style.color = '#fff';
            } else if(type === 'warning') {
                header.style.background = 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)';
                header.querySelector('h3').style.color = '#fff';
            } else {
                header.style.background = 'linear-gradient(135deg, var(--primary) 0%, #FCD34D 100%)';
                header.querySelector('h3').style.color = 'var(--secondary)';
            }
            
            alertCallback = onClose;
            document.getElementById('alert-modal').classList.add('active');
        }
        
        function closeAlertModal() {
            document.getElementById('alert-modal').classList.remove('active');
            if(alertCallback) alertCallback();
            alertCallback = null;
        }
        
        // Logo deƒüi≈ütirme
        function changeLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const logo = document.getElementById('brand-logo');
                        logo.src = ev.target.result;
                        logo.style.display = 'block';
                        localStorage.setItem('brand_logo', ev.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // Sayfa y√ºklendiƒüinde kayƒ±tlƒ± logoyu y√ºkle
        function loadSavedLogo() {
            const savedLogo = localStorage.getItem('brand_logo');
            if(savedLogo) {
                const logo = document.getElementById('brand-logo');
                logo.src = savedLogo;
                logo.style.display = 'block';
            }
        }

        // Kaydedilmemi≈ü deƒüi≈üiklik g√∂stergesi
        function showUnsaved() {
            hasUnsavedChanges = true;
            const btn = document.querySelector('.sidebar-footer .btn-success');
            if(btn) {
                btn.style.background = '#ef4444';
                btn.innerHTML = '‚ö†Ô∏è Deƒüi≈üiklikleri Kaydet';
                btn.style.animation = 'pulse 1s infinite';
            }
        }
        
        function clearUnsaved() {
            hasUnsavedChanges = false;
            const btn = document.querySelector('.sidebar-footer .btn-success');
            if(btn) {
                btn.style.background = '';
                btn.innerHTML = 'üíæ GitHub\'a Kaydet';
                btn.style.animation = '';
            }
        }

        window.onload = () => { 
            if(localStorage.getItem('gh_token')) document.getElementById('gh-token').value = localStorage.getItem('gh_token'); 
            loadSavedLogo();
        }

        async function startLogin() {
            if(WORKER_URL.endsWith('/list')) WORKER_URL = WORKER_URL.replace('/list', '');
            if(WORKER_URL.endsWith('/')) WORKER_URL = WORKER_URL.slice(0, -1);
            CRED = {
                token: document.getElementById('gh-token').value,
                owner: document.getElementById('gh-owner').value,
                repo: document.getElementById('gh-repo').value,
                branch: document.getElementById('gh-branch').value,
                path: document.getElementById('gh-path').value
            };
            if(!CRED.token) return alert("Token Giriniz!");
            localStorage.setItem('gh_token', CRED.token);
            document.getElementById('loader').style.display='flex';
            try {
                if(WORKER_URL) { try { const r = await fetch(WORKER_URL + "/list"); if(r.ok) R2_FILES = await r.json(); } catch(e) { console.warn("R2:",e); } }
                const u = `https://api.github.com/repos/${CRED.owner}/${CRED.repo}/contents/${CRED.path}?ref=${CRED.branch}`;
                const res = await fetch(u, {headers:{'Authorization':`token ${CRED.token}`}});
                if(!res.ok) throw new Error("GitHub Hatasƒ±: " + res.status);
                const d = await res.json();
                SHA = d.sha;
                DATA = JSON.parse(decodeURIComponent(escape(window.atob(d.content))));
                document.getElementById('login-overlay').style.display='none';
                renderTree();
            } catch(e) { alert(e.message); } 
            finally { document.getElementById('loader').style.display='none'; }
        }

        // --- DOSYA Y√ñNETƒ∞Cƒ∞Sƒ∞ ---
        function openFileManager() { TARGET_ID=null; openMedia(null, 'all'); } 
        function openMedia(id, type) { TARGET_ID = id; CHECKED_FILES.clear(); document.getElementById('media-modal').style.display='flex'; CUR_PATH=""; renderFiles(); updateToolbar(); }
        function setViewMode(mode) { VIEW_MODE = mode; document.getElementById('mw-header').style.display = (mode === 'list') ? 'grid' : 'none'; renderFiles(); }
        function renderFiles() {
            const container = document.getElementById('mw-body'); container.className = `mw-body view-${VIEW_MODE}`; container.innerHTML='';
            document.getElementById('cur-path').innerText = CUR_PATH || "/ (Ana Dizin)";
            let items = [];
            const searchVal = document.getElementById('search-in').value.toLowerCase();
            const src = searchVal ? R2_FILES : R2_FILES.filter(f => f.key.startsWith(CUR_PATH));
            src.forEach(f => {
                const relative = f.key.slice(CUR_PATH.length); const parts = relative.split('/');
                if(searchVal) { if(f.key.toLowerCase().includes(searchVal)) items.push({type:'file', key:f.key, name:f.key, size:f.size, date:f.uploaded}); } 
                else { if(parts.length > 1 && parts[0]) { if(!items.find(i=>i.name===parts[0] && i.type==='folder')) items.push({type:'folder', name:parts[0]}); } 
                else if(parts.length === 1 && parts[0]!=='') { items.push({type:'file', key:f.key, name:parts[0], size:f.size, date:f.uploaded}); } }
            });
            items.sort((a,b) => (a.type==='folder'?-1:1));
            window.CURRENT_ITEMS = items;
            items.forEach(it => {
                const el = document.createElement('div'); el.className='file-item';
                const uniqueId = it.type === 'folder' ? (CUR_PATH + it.name + "/") : it.key;
                if(CHECKED_FILES.has(uniqueId)) el.classList.add('selected-row');
                const chk = document.createElement('input'); chk.type='checkbox'; chk.className='item-check'; chk.checked = CHECKED_FILES.has(uniqueId);
                chk.onclick = (e) => { e.stopPropagation(); if(chk.checked) { CHECKED_FILES.add(uniqueId); el.classList.add('selected-row'); } else { CHECKED_FILES.delete(uniqueId); el.classList.remove('selected-row'); } updateToolbar(); };
                
                // ƒ∞kon ve thumbnail
                const isImage = it.type==='file' && it.name.match(/\.(jpg|jpeg|png|webp|gif)$/i);
                const editBtn = document.createElement('button'); editBtn.className = 'action-btn btn-edit'; editBtn.innerHTML = '‚úèÔ∏è'; editBtn.onclick = (e) => { e.stopPropagation(); renameItem(uniqueId, it.type); };
                const delBtn = document.createElement('button'); delBtn.className = 'action-btn btn-del'; delBtn.innerHTML = 'üóëÔ∏è'; delBtn.onclick = (e) => { e.stopPropagation(); deleteSingleItem(uniqueId, it.type); };
                
                if(VIEW_MODE === 'list') {
                    // Liste g√∂r√ºn√ºm√º - k√º√ß√ºk thumbnail
                    let thumbHtml = it.type==='folder' ? '<div style="font-size:24px; text-align:center;">üìÇ</div>' : '<div style="font-size:24px; text-align:center;">üìÑ</div>';
                    if(isImage) thumbHtml = `<img src="${WORKER_URL}/get/${it.key}" class="file-thumb">`;
                    const dateStr = it.date ? new Date(it.date).toLocaleDateString() : '-'; 
                    const sizeStr = it.size ? (it.size/1024).toFixed(1)+' KB' : '-';
                    el.appendChild(chk); 
                    el.insertAdjacentHTML('beforeend', `<div style="width:50px; height:40px; display:flex; align-items:center; justify-content:center; overflow:hidden;">${thumbHtml}</div><div class="file-name" title="${it.name}">${it.name}</div><div class="file-meta">${dateStr}</div><div class="file-meta">${sizeStr}</div>`); 
                    el.appendChild(editBtn); 
                    el.appendChild(delBtn);
                } else {
                    // Grid g√∂r√ºn√ºm√º
                    let thumbHtml = it.type==='folder' ? '<div style="font-size:36px;">üìÇ</div>' : '<div style="font-size:36px;">üìÑ</div>';
                    if(isImage) thumbHtml = `<img src="${WORKER_URL}/get/${it.key}" class="file-thumb">`;
                    el.appendChild(chk); 
                    el.insertAdjacentHTML('beforeend', `<div style="width:60px; height:60px; display:flex; align-items:center; justify-content:center; overflow:hidden;">${thumbHtml}</div><div class="file-name" title="${it.name}">${it.name}</div>`);
                    const actions = document.createElement('div'); actions.className = 'grid-actions'; actions.appendChild(editBtn); actions.appendChild(delBtn); el.appendChild(actions);
                }
                el.onclick = () => { if(it.type==='folder') { CUR_PATH += it.name + "/"; document.getElementById('search-in').value=""; renderFiles(); updateHeaderCheck(); } else { if(TARGET_ID) { document.getElementById(TARGET_ID).value = "/" + it.key; closeMedia(); if(TARGET_ID==='p-model') updateGlbPreview(); else document.getElementById(TARGET_ID).dispatchEvent(new Event('input')); } } };
                container.appendChild(el);
            });
            updateToolbar();
        }

        // --- DOSYA ƒ∞≈ûLEMLERƒ∞ ---
        async function renameItem(oldKey, type) {
            const oldName = oldKey.replace(/\/$/, '').split('/').pop(); const newName = prompt("Yeni Ad:", oldName); if(!newName || newName === oldName) return;
            const base = oldKey.substring(0, oldKey.lastIndexOf(oldName)); document.getElementById('loader').style.display='flex';
            if(type === 'file') { await moveReq(oldKey, base + newName); } 
            else { const prefix = oldKey; const newPrefix = base + newName + "/"; const files = R2_FILES.filter(f => f.key.startsWith(prefix)); for(const f of files) { const dest = newPrefix + f.key.slice(prefix.length); await moveReq(f.key, dest); } }
            CHECKED_FILES.clear(); await refreshList(); updateToolbar(); document.getElementById('loader').style.display='none';
        }
        async function createNewFolder() {
            const folderName = prompt("Klas√∂r Adƒ±:"); if(!folderName) return;
            const safeName = folderName.replace(/[^a-zA-Z0-9_\-\s]/g, ""); await fetch(WORKER_URL + "/upload/" + CUR_PATH + safeName + "/.keep", { method: "PUT", body: "" }); await refreshList();
        }
        async function copyReq(src, dest) { try { await fetch(WORKER_URL + "/copy", { method: 'POST', body: JSON.stringify({source: src, destination: dest}) }); } catch(e) { console.error(e); } }
        async function moveReq(src, dest) { try { await fetch(WORKER_URL + "/move", { method: 'POST', body: JSON.stringify({source: src, destination: dest}) }); } catch(e) { console.error(e); } }
        function copySelected() { if(CHECKED_FILES.size === 0) return; CLIPBOARD = Array.from(CHECKED_FILES); CLIPBOARD_ACTION = 'copy'; CHECKED_FILES.clear(); renderFiles(); updateToolbar(); alert("Kopyalandƒ±!"); }
        function moveSelected() { if(CHECKED_FILES.size === 0) return; CLIPBOARD = Array.from(CHECKED_FILES); CLIPBOARD_ACTION = 'move'; CHECKED_FILES.clear(); renderFiles(); updateToolbar(); alert("Kesildi!"); }
        async function pasteFiles() {
            if(CLIPBOARD.length === 0) return; if(!confirm(`${CLIPBOARD.length} √∂ƒüe yapƒ±≈ütƒ±rƒ±lsƒ±n mƒ±?`)) return;
            document.getElementById('loader').style.display='flex';
            for(const item of CLIPBOARD) {
                const isFolder = item.endsWith('/');
                if(!isFolder) {
                    let fileName = item.split('/').pop(); let dest = CUR_PATH + fileName;
                    if(item === dest && CLIPBOARD_ACTION === 'copy') { const parts = fileName.split('.'); const ext = parts.length > 1 ? parts.pop() : ""; dest = CUR_PATH + parts.join('.') + " kopya" + (ext ? "."+ext : ""); }
                    if(CLIPBOARD_ACTION === 'copy') await copyReq(item, dest); else if(item !== dest) await moveReq(item, dest);
                } else {
                    const folderName = item.split('/').filter(x=>x).pop(); const oldPrefix = item; let newPrefix = CUR_PATH + folderName + "/";
                    if(oldPrefix === newPrefix && CLIPBOARD_ACTION === 'copy') { newPrefix = CUR_PATH + folderName + " kopya/"; }
                    const files = R2_FILES.filter(f => f.key.startsWith(oldPrefix));
                    for(const f of files) { const dest = newPrefix + f.key.slice(oldPrefix.length); if(CLIPBOARD_ACTION === 'copy') await copyReq(f.key, dest); else if(f.key !== dest) await moveReq(f.key, dest); }
                }
            }
            await refreshList(); CLIPBOARD = []; updateToolbar(); document.getElementById('loader').style.display='none';
        }
        async function deleteBatch() {
            if(!confirm(`${CHECKED_FILES.size} √∂ƒüe silinsin mi?`)) return; document.getElementById('btn-batch-delete').innerText = "Siliniyor...";
            for(const key of CHECKED_FILES) { if(key.endsWith('/')) { const files = R2_FILES.filter(f => f.key.startsWith(key)); for(const f of files) await fetch(WORKER_URL + "/delete/" + f.key, {method:'DELETE'}); } else { await fetch(WORKER_URL + "/delete/" + key, {method:'DELETE'}); } }
            CHECKED_FILES.clear(); await refreshList(); updateToolbar(); updateHeaderCheck();
        }
        async function deleteSingleItem(key, type) {
            if(!confirm(`"${key}" silinsin mi?`)) return;
            if(type === 'folder') { const files = R2_FILES.filter(f => f.key.startsWith(key)); for(const f of files) await fetch(WORKER_URL + "/delete/" + f.key, {method:'DELETE'}); } 
            else { await fetch(WORKER_URL + "/delete/" + key, {method:'DELETE'}); } await refreshList();
        }
        async function refreshList() { const r = await fetch(WORKER_URL+"/list"); if(r.ok) R2_FILES = await r.json(); renderFiles(); }
        function updateToolbar() {
            const btnDel = document.getElementById('btn-batch-delete'); const btnCopy = document.getElementById('btn-copy'); const btnMove = document.getElementById('btn-move'); const btnPaste = document.getElementById('btn-paste');
            if(CHECKED_FILES.size > 0) { btnDel.innerHTML = `üóëÔ∏è Sil (${CHECKED_FILES.size})`; btnDel.style.opacity = '1'; btnDel.style.pointerEvents = 'auto'; btnCopy.style.display = 'inline-flex'; btnCopy.innerHTML = `üìã Kopyala (${CHECKED_FILES.size})`; btnMove.style.display = 'inline-flex'; btnMove.innerHTML = `‚úÇÔ∏è Ta≈üƒ± (${CHECKED_FILES.size})`; } 
            else { btnDel.innerHTML = `üóëÔ∏è Sil`; btnDel.style.opacity = '0.5'; btnDel.style.pointerEvents = 'none'; btnCopy.style.display = 'none'; btnMove.style.display = 'none'; }
            if(CLIPBOARD.length > 0) { const icon = CLIPBOARD_ACTION === 'copy' ? 'üìã' : '‚úÇÔ∏è'; btnPaste.style.display = 'inline-flex'; btnPaste.innerHTML = `${icon} Yapƒ±≈ütƒ±r (${CLIPBOARD.length})`; } else { btnPaste.style.display = 'none'; }
        }
        function toggleSelectAll(masterChk) { const items = window.CURRENT_ITEMS || []; items.forEach(it => { const uid = it.type === 'folder' ? (CUR_PATH + it.name + "/") : it.key; if(masterChk.checked) CHECKED_FILES.add(uid); else CHECKED_FILES.delete(uid); }); renderFiles(); updateToolbar(); }
        function updateHeaderCheck() { document.getElementById('master-check').checked = false; }
        async function uploadToR2(file) {
            if(!file) return; const k = CUR_PATH + file.name; if(!confirm(`Y√ºklensin mi: ${file.name}`)) return; document.getElementById('loader').style.display='flex';
            try { await fetch(WORKER_URL + "/upload/" + k, { method:"PUT", body:file }); await refreshList(); } catch(e) { alert(e.message); } finally { document.getElementById('loader').style.display='none'; }
        }
        function navUp() { if(!CUR_PATH)return; const p=CUR_PATH.split('/'); p.pop(); p.pop(); CUR_PATH=p.length>0?p.join('/')+"/":""; renderFiles(); updateHeaderCheck(); }
        function closeMedia() { document.getElementById('media-modal').style.display='none'; }

        // --- ANA FONKSƒ∞YONLAR ---
        function renderTree() {
            const root = document.getElementById('tree-root'); root.innerHTML=''; 
            const sel = document.getElementById('p-cat'); sel.innerHTML='';
            
            DATA.forEach((c,i) => {
                sel.innerHTML += `<option value="${i}">${c.name}</option>`;
                const div = document.createElement('div'); div.className='tree-cat-group';
                
                // Kategori Ba≈ülƒ±ƒüƒ±
                const header = document.createElement('div');
                header.className = 'tree-cat-header';
                header.innerHTML = `
                    <span class="cat-name" data-cat="${i}">${c.name}</span>
                    <div class="cat-actions">
                        <span class="cat-btn cat-add" onclick="event.stopPropagation(); addProdToCat(${i})" title="√úr√ºn Ekle">+</span>
                        <span class="cat-btn cat-del" onclick="delCat(event, ${i})" title="Kategori Sil">üóëÔ∏è</span>
                    </div>
                `;
                // Kategori ismine √ßift tƒ±klayƒ±nca inline d√ºzenleme
                header.querySelector('.cat-name').ondblclick = (e) => { e.stopPropagation(); inlineEditCat(i, e.target); };
                div.appendChild(header);
                
                c.products.forEach((p,j) => { 
                    const item = document.createElement('div'); 
                    item.className = 'tree-item'; 
                    if(i === CAT && j === PROD) item.classList.add('active'); 
                    
                    item.innerHTML = `
                        <span class="prod-name" data-cat="${i}" data-prod="${j}">üì¶ ${p.name||'Adsƒ±z'}</span>
                        <span class="prod-del" onclick="event.stopPropagation(); delProdDirect(${i}, ${j})" title="√úr√ºn√º Sil">üóëÔ∏è</span>
                    `;
                    // √úr√ºn ismine √ßift tƒ±klayƒ±nca inline d√ºzenleme
                    item.querySelector('.prod-name').ondblclick = (e) => { e.stopPropagation(); inlineEditProd(i, j, e.target); };
                    item.querySelector('.prod-name').onclick = (e) => { e.stopPropagation(); loadProd(i,j,item); };
                    div.appendChild(item); 
                });
                root.appendChild(div);
            });
        }
        
        // Inline kategori ismi d√ºzenleme
        function inlineEditCat(catIndex, el) {
            const oldName = DATA[catIndex].name;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.className = 'inline-edit';
            input.onclick = (e) => e.stopPropagation();
            
            const finishEdit = () => {
                const newName = input.value.trim();
                if(newName && newName !== oldName) {
                    DATA[catIndex].name = newName;
                    showUnsaved();
                }
                renderTree();
            };
            
            input.onblur = finishEdit;
            input.onkeydown = (e) => { 
                if(e.key === 'Enter') { e.preventDefault(); finishEdit(); }
                if(e.key === 'Escape') { renderTree(); }
            };
            
            el.replaceWith(input);
            input.focus();
            input.select();
        }
        
        // Inline √ºr√ºn ismi d√ºzenleme
        function inlineEditProd(catIndex, prodIndex, el) {
            const oldName = DATA[catIndex].products[prodIndex].name;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.className = 'inline-edit';
            input.onclick = (e) => e.stopPropagation();
            
            const finishEdit = () => {
                const newName = input.value.trim();
                if(newName && newName !== oldName) {
                    DATA[catIndex].products[prodIndex].name = newName;
                    // Eƒüer bu √ºr√ºn ≈üu an d√ºzenleme panelinde a√ßƒ±ksa formu da g√ºncelle
                    if(CAT === catIndex && PROD === prodIndex) {
                        document.getElementById('p-name').value = newName;
                    }
                    showUnsaved();
                }
                renderTree();
            };
            
            input.onblur = finishEdit;
            input.onkeydown = (e) => { 
                if(e.key === 'Enter') { e.preventDefault(); finishEdit(); }
                if(e.key === 'Escape') { renderTree(); }
            };
            
            el.innerHTML = '';
            el.appendChild(input);
            input.focus();
            input.select();
        }
        
        // Belirli kategoriye √ºr√ºn ekle
        function addProdToCat(catIndex) {
            DATA[catIndex].products.push({name:"Yeni √úr√ºn", sku:"", thumb:"", desc:"", link:"", model:"", price:0, variantGroups:[]});
            renderTree();
            showUnsaved();
        }
        
        // Direkt √ºr√ºn silme (tree'den)
        function delProdDirect(catIndex, prodIndex) {
            const prodName = DATA[catIndex].products[prodIndex].name || 'Adsƒ±z';
            
            showConfirm(
                'üóëÔ∏è √úr√ºn Sil',
                `<strong>"${prodName}"</strong> √ºr√ºn√º silinecek.<br><br>Bu i≈ülem geri alƒ±namaz!`,
                () => {
                    DATA[catIndex].products.splice(prodIndex, 1);
                    if(CAT === catIndex && PROD === prodIndex) {
                        document.getElementById('editor-area').classList.add('hidden');
                        PROD = -1;
                    } else if(CAT === catIndex && PROD > prodIndex) {
                        PROD--;
                    }
                    renderTree();
                    showUnsaved();
                },
                'Sil',
                'danger'
            );
        }
        function loadProd(i,j,el) {
            // √ñnceki √ºr√ºn√º hafƒ±zaya al
            if(PROD>-1) saveMem(); 
            
            // Yeni se√ßimleri ata
            CAT=i; PROD=j;
            
            // --- KRƒ∞Tƒ∞K: Aƒüacƒ± yenile ki vurgulama (sarƒ± ƒ±≈üƒ±k) g√ºncellensin ---
            renderTree(); 
            
            document.getElementById('editor-area').classList.remove('hidden');
            const p = DATA[i].products[j];
            
            // Formu doldur
            ['p-name','p-sku','p-thumb','p-desc','p-link','p-model'].forEach(k => document.getElementById(k).value = p[k.split('-')[1]] || '');
            document.getElementById('p-price').value = p.price || 0; 
            document.getElementById('p-cat').value = i;
            
            renderVars(p.variantGroups||[]); 
            updateGlbPreview();
        }
        
        // Local GLB dosyasƒ± i√ßin ge√ßici URL
        let localGlbUrl = null;
        
        function updateGlbPreview() {
            const path = document.getElementById('p-model').value; 
            const viewer = document.getElementById('viewer'); 
            const list = document.getElementById('mat-list');
            
            if(!path) { 
                viewer.src=""; 
                list.innerHTML="<div style='padding:15px; text-align:center; color:#94a3b8; font-size:12px;'>Model Se√ßilmedi</div>"; 
                window.MATS = [];
                return; 
            }
            
            // Eƒüer local blob URL ise direkt kullan, deƒüilse R2'den √ßek
            let srcUrl;
            if(path.startsWith('blob:') || localGlbUrl) {
                srcUrl = localGlbUrl || path;
            } else {
                const cleanPath = path.startsWith('/') ? path.slice(1) : path; 
                srcUrl = WORKER_URL + "/get/" + cleanPath + "?t=" + new Date().getTime();
            }
            
            viewer.src = srcUrl;
            list.innerHTML = "<div style='padding:15px; text-align:center; color:#94a3b8; font-size:12px;'>Model y√ºkleniyor...</div>";
            
            viewer.addEventListener('load', () => {
                list.innerHTML = ''; window.MATS = [];
                if(viewer.model && viewer.model.materials) {
                    viewer.model.materials.forEach(m => {
                        window.MATS.push(m.name);
                        const el = document.createElement('div'); el.className='mat-item'; el.innerHTML = `<span>${m.name}</span> <span>‚û§</span>`;
                        el.onclick = () => { highlightMaterial(m.name); if(LAST_INPUT){ LAST_INPUT.value = m.name; LAST_INPUT.dispatchEvent(new Event('input')); } };
                        list.appendChild(el);
                    });
                    // Materyal bulundu bildirimi
                    if(window.MATS.length > 0) {
                        console.log(`‚úÖ ${window.MATS.length} materyal bulundu:`, window.MATS);
                    }
                } else {
                    list.innerHTML = "<div style='padding:15px; text-align:center; color:#f59e0b; font-size:12px;'>Materyal bulunamadƒ±</div>";
                }
            }, {once:true});
            
            viewer.addEventListener('error', () => {
                list.innerHTML = "<div style='padding:15px; text-align:center; color:#ef4444; font-size:12px;'>Model y√ºklenemedi</div>";
            }, {once:true});
        }
        
        // GLB dosyasƒ±nƒ± bilgisayardan se√ßip local olarak y√ºkle
        function selectLocalGlb() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.glb,.gltf';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                // Local blob URL olu≈ütur
                if(localGlbUrl) URL.revokeObjectURL(localGlbUrl);
                localGlbUrl = URL.createObjectURL(file);
                
                // Input'a dosya adƒ±nƒ± yaz (daha sonra R2'ye y√ºklenecek path)
                document.getElementById('p-model').value = `/models/${file.name}`;
                document.getElementById('p-model').dataset.localFile = file.name;
                document.getElementById('p-model').dataset.pendingUpload = 'true';
                
                // Dosyayƒ± hafƒ±zada tut
                window.pendingGlbFile = file;
                
                // Preview'ƒ± g√ºncelle
                updateGlbPreview();
                showUnsaved();
                
                showAlert('üì¶ GLB Y√ºklendi', `<strong>${file.name}</strong> dosyasƒ± y√ºklendi.<br><br>Artƒ±k "GLB'den Gruplarƒ± Olu≈ütur" butonunu kullanabilirsiniz.<br><br><small style="color:#64748b;">Not: Dosya GitHub'a kaydederken otomatik olarak R2'ye y√ºklenecektir.</small>`, 'success');
            };
            input.click();
        }
        function highlightMaterial(matName) {
            const viewer = document.getElementById('viewer'); if (!viewer.model) return;
            const mat = viewer.model.materials.find(m => m.name === matName); if (!mat) return;
            const originalColor = [...mat.pbrMetallicRoughness.baseColorFactor];
            mat.pbrMetallicRoughness.setBaseColorFactor([1, 0, 0, 1]); setTimeout(() => { mat.pbrMetallicRoughness.setBaseColorFactor(originalColor); }, 500);
        }
        function autoFill() {
            if(!window.MATS || window.MATS.length===0) {
                return showAlert('‚ö†Ô∏è Uyarƒ±', '√ñnce bir GLB model y√ºkleyin!', 'warning');
            }
            showConfirm(
                '‚ö° Otomatik Varyasyon',
                `<strong>${window.MATS.length}</strong> materyal bulundu.<br><br>Her materyal i√ßin otomatik varyasyon grubu olu≈üturulsun mu?`,
                () => {
                    const newGrps = []; 
                    window.MATS.forEach(m => { 
                        const autoName = m + "_baseColor.png"; 
                        newGrps.push({ groupName: m, items: [{ name: "Orijinal", value: autoName, textureConfig: { materialName: m, baseColor: autoName } }] }); 
                    });
                    if (!DATA[CAT].products[PROD].variantGroups) DATA[CAT].products[PROD].variantGroups = [];
                    DATA[CAT].products[PROD].variantGroups = [...DATA[CAT].products[PROD].variantGroups, ...newGrps]; 
                    renderVars(DATA[CAT].products[PROD].variantGroups);
                    showUnsaved();
                    showAlert('‚úÖ Ba≈üarƒ±lƒ±', `${window.MATS.length} varyasyon grubu olu≈üturuldu!`, 'success');
                },
                'Olu≈ütur',
                'success'
            );
        }
        function renderVars(grps) {
            const div = document.getElementById('v-container'); div.innerHTML='';
            
            // Toplu grup silme butonu
            div.insertAdjacentHTML('beforebegin', '');
            let batchActionsHtml = document.getElementById('v-batch-actions');
            if(!batchActionsHtml) {
                const batchDiv = document.createElement('div');
                batchDiv.id = 'v-batch-actions';
                batchDiv.className = 'v-batch-actions hidden';
                batchDiv.innerHTML = `
                    <input type="checkbox" id="select-all-groups" class="v-group-check" onchange="toggleAllGroups(this.checked)">
                    <span class="v-batch-count"><span id="selected-group-count">0</span> grup se√ßildi</span>
                    <button class="btn btn-danger" onclick="deleteSelectedGroups()">üóëÔ∏è Se√ßili Gruplarƒ± Sil</button>
                `;
                div.parentElement.insertBefore(batchDiv, div);
            }
            
            // Grup varsa batch actions g√∂ster
            document.getElementById('v-batch-actions').classList.toggle('hidden', grps.length === 0);
            
            grps.forEach((g,gi) => {
                const gDiv = document.createElement('div'); gDiv.className='v-group';
                let itemsHtml = '';
                
                // Item batch actions
                itemsHtml += `<div class="v-item-batch-actions hidden" id="item-batch-${gi}">
                    <input type="checkbox" class="v-item-check" onchange="toggleAllItems(${gi}, this.checked)">
                    <span class="v-batch-count"><span id="selected-item-count-${gi}">0</span> √∂ƒüe se√ßildi</span>
                    <button class="btn btn-danger" style="padding:4px 10px; font-size:11px;" onclick="deleteSelectedItems(${gi})">üóëÔ∏è Se√ßili √ñƒüeleri Sil</button>
                </div>`;
                
                g.items.forEach((it,ii) => {
                    itemsHtml += `<div class="v-item" data-group="${gi}" data-item="${ii}">
                        <input type="checkbox" class="v-item-check item-check-${gi}" onchange="updateItemSelection(${gi})">
                        <div><div class="v-item-label">Varyasyon Adƒ±</div><input value="${it.name}" oninput="updVar(${gi},${ii},'name',this.value)"></div>
                        <div><div class="v-item-label">Resim</div><div class="input-group-btn"><input value="${it.value}" id="vi-${gi}-${ii}" oninput="updVar(${gi},${ii},'value',this.value)"><button class="btn btn-primary" onclick="openMedia('vi-${gi}-${ii}','image')">..</button></div></div>
                        <div><div class="v-item-label">GLB Mat ID</div><input value="${it.textureConfig?.materialName||''}" onfocus="registerFocus(this)" oninput="updConf(${gi},${ii},'materialName',this.value)"></div>
                        <div><div class="v-item-label">Doku Dosyasƒ±</div><div class="input-group-btn"><input value="${it.textureConfig?.baseColor||''}" id="vt-${gi}-${ii}" oninput="updConf(${gi},${ii},'baseColor',this.value)"><button class="btn btn-primary" onclick="openMedia('vt-${gi}-${ii}','image')">..</button></div></div>
                        <button class="btn btn-danger" style="height:35px;" onclick="delItem(${gi},${ii})">X</button>
                    </div>`;
                });
                
                gDiv.innerHTML = `
                    <div class="v-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" class="v-group-check group-check" data-group="${gi}" onclick="event.stopPropagation()" onchange="updateGroupSelection()">
                            <span class="arrow">‚ñº</span>
                            <input value="${g.groupName}" onclick="event.stopPropagation()" oninput="DATA[CAT].products[PROD].variantGroups[${gi}].groupName=this.value">
                        </div>
                        <button class="btn btn-danger" onclick="delGrp(event, ${gi})">Sil</button>
                    </div>
                    <div class="v-body">${itemsHtml}<button class="btn btn-ghost" style="width:100%" onclick="addItem(${gi})">+ Ekle</button></div>`;
                div.appendChild(gDiv);
            });
        }
        
        // Grup se√ßimi g√ºncelle
        function updateGroupSelection() {
            const checked = document.querySelectorAll('.group-check:checked').length;
            document.getElementById('selected-group-count').textContent = checked;
        }
        
        // T√ºm gruplarƒ± se√ß/kaldƒ±r
        function toggleAllGroups(checked) {
            document.querySelectorAll('.group-check').forEach(cb => cb.checked = checked);
            updateGroupSelection();
        }
        
        // Se√ßili gruplarƒ± sil
        function deleteSelectedGroups() {
            const checkedGroups = [...document.querySelectorAll('.group-check:checked')];
            if(checkedGroups.length === 0) {
                return showAlert('‚ö†Ô∏è Uyarƒ±', 'Hi√ß grup se√ßilmedi!', 'warning');
            }
            
            showConfirm(
                'üóëÔ∏è Gruplarƒ± Sil',
                `<strong>${checkedGroups.length}</strong> varyasyon grubu silinecek.<br><br>Bu i≈ülem geri alƒ±namaz. Devam etmek istiyor musunuz?`,
                () => {
                    const indices = checkedGroups.map(cb => parseInt(cb.dataset.group)).sort((a,b) => b-a);
                    indices.forEach(i => DATA[CAT].products[PROD].variantGroups.splice(i, 1));
                    renderVars(DATA[CAT].products[PROD].variantGroups);
                    showUnsaved();
                },
                'Sil',
                'danger'
            );
        }
        
        // Item se√ßimi g√ºncelle
        function updateItemSelection(gi) {
            const checked = document.querySelectorAll(`.item-check-${gi}:checked`).length;
            document.getElementById(`selected-item-count-${gi}`).textContent = checked;
            document.getElementById(`item-batch-${gi}`).classList.toggle('hidden', checked === 0);
        }
        
        // T√ºm item'larƒ± se√ß/kaldƒ±r
        function toggleAllItems(gi, checked) {
            document.querySelectorAll(`.item-check-${gi}`).forEach(cb => cb.checked = checked);
            updateItemSelection(gi);
        }
        
        // Se√ßili item'larƒ± sil
        function deleteSelectedItems(gi) {
            const checkedItems = [...document.querySelectorAll(`.item-check-${gi}:checked`)];
            if(checkedItems.length === 0) {
                return showAlert('‚ö†Ô∏è Uyarƒ±', 'Hi√ß √∂ƒüe se√ßilmedi!', 'warning');
            }
            
            showConfirm(
                'üóëÔ∏è √ñƒüeleri Sil',
                `<strong>${checkedItems.length}</strong> varyasyon √∂ƒüesi silinecek.<br><br>Bu i≈ülem geri alƒ±namaz. Devam etmek istiyor musunuz?`,
                () => {
                    const indices = [];
                    checkedItems.forEach(cb => {
                        const vItem = cb.closest('.v-item');
                        if(vItem && vItem.dataset.item !== undefined) {
                            indices.push(parseInt(vItem.dataset.item));
                        }
                    });
                    indices.sort((a,b) => b-a);
                    indices.forEach(i => DATA[CAT].products[PROD].variantGroups[gi].items.splice(i, 1));
                    renderVars(DATA[CAT].products[PROD].variantGroups);
                    showUnsaved();
                },
                'Sil',
                'danger'
            );
        }

        // --- UTILS ---
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); event.target.classList.add('active'); document.getElementById('tab-'+t).classList.add('active'); }
        function registerFocus(el) { LAST_INPUT=el; }
        
        // √úr√ºn adƒ± deƒüi≈üince tree'de g√ºncelle
        function updateProdNameInTree() {
            if(CAT > -1 && PROD > -1) {
                const newName = document.getElementById('p-name').value;
                DATA[CAT].products[PROD].name = newName;
                // Tree'deki ilgili item'ƒ± g√ºncelle
                const prodNameEl = document.querySelector(`.prod-name[data-cat="${CAT}"][data-prod="${PROD}"]`);
                if(prodNameEl) {
                    prodNameEl.innerHTML = `üì¶ ${newName || 'Adsƒ±z'}`;
                }
                showUnsaved();
            }
        }
        
        function saveMem() { const p=DATA[CAT].products[PROD]; ['name','sku','thumb','desc','link','model'].forEach(k=>p[k]=document.getElementById('p-'+k).value); p.price=document.getElementById('p-price').value; }
        // editCat artƒ±k inline d√ºzenleme ile deƒüi≈ütirildi
        window.delCat = (e, i) => { 
            e.stopPropagation(); 
            const catName = DATA[i].name;
            const prodCount = DATA[i].products.length;
            
            showConfirm(
                'üóëÔ∏è Kategori Sil',
                `<strong>"${catName}"</strong> kategorisi${prodCount > 0 ? ` ve i√ßindeki <strong>${prodCount}</strong> √ºr√ºn` : ''} silinecek.<br><br>Bu i≈ülem geri alƒ±namaz!`,
                () => {
                    DATA.splice(i, 1); 
                    if (CAT === i) { 
                        document.getElementById('editor-area').classList.add('hidden'); 
                        CAT = -1; 
                        PROD = -1; 
                    } else if (CAT > i) { 
                        CAT--; 
                    } 
                    renderTree(); 
                    showUnsaved();
                },
                'Sil',
                'danger'
            );
        }
        window.newCat = () => { 
            document.getElementById('cat-modal').classList.add('active');
            document.getElementById('new-cat-name').value = '';
            setTimeout(() => document.getElementById('new-cat-name').focus(), 100);
        }
        
        function closeCatModal() {
            document.getElementById('cat-modal').classList.remove('active');
        }
        
        function confirmNewCat() {
            const name = document.getElementById('new-cat-name').value.trim();
            if(name) {
                DATA.push({ name: name, products: [] });
                renderTree();
                showUnsaved();
                closeCatModal();
            } else {
                document.getElementById('new-cat-name').focus();
            }
        }
        
        // Enter tu≈üu ile kategori olu≈ütur
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('cat-modal').classList.contains('active')) {
                if(e.key === 'Enter') confirmNewCat();
                if(e.key === 'Escape') closeCatModal();
            }
        });
        window.newProd = () => { 
    if(!DATA.length) return alert("√ñnce bir kategori olu≈üturun!"); 
    if(CAT == -1) CAT = 0; 
    DATA[CAT].products.push({name:"Yeni √úr√ºn", sku:"", thumb:"", desc:"", link:"", model:"", price:0, variantGroups:[]}); 
    renderTree(); 
    showUnsaved();
}
        window.delProd = () => { 
    if(confirm("Bu √ºr√ºn√º silmek istediƒüinize emin misiniz?")) { 
        DATA[CAT].products.splice(PROD, 1); 
        document.getElementById('editor-area').classList.add('hidden'); 
        PROD = -1;
        renderTree(); 
        showUnsaved();
    } 
}
        window.moveCat = () => { 
    const newCatIndex = parseInt(document.getElementById('p-cat').value); 
    if(newCatIndex === CAT) return;
    saveMem(); 
    const p = DATA[CAT].products.splice(PROD, 1)[0]; 
    DATA[newCatIndex].products.push(p); 
    CAT = newCatIndex;
    PROD = DATA[newCatIndex].products.length - 1;
    renderTree(); 
    showUnsaved();
}
        window.updVar=(g,i,k,v)=>DATA[CAT].products[PROD].variantGroups[g].items[i][k]=v;
        window.updConf=(g,i,k,v)=>{ if(!DATA[CAT].products[PROD].variantGroups[g].items[i].textureConfig)DATA[CAT].products[PROD].variantGroups[g].items[i].textureConfig={}; DATA[CAT].products[PROD].variantGroups[g].items[i].textureConfig[k]=v; }
        window.addGrp=()=>{ DATA[CAT].products[PROD].variantGroups.push({groupName:"Yeni",items:[]}); renderVars(DATA[CAT].products[PROD].variantGroups); }
        window.addItem=(g)=>{ DATA[CAT].products[PROD].variantGroups[g].items.push({name:"Yeni",value:"",textureConfig:{}}); renderVars(DATA[CAT].products[PROD].variantGroups); }
        window.delGrp=(e,g)=>{ 
            e.stopPropagation(); 
            const grpName = DATA[CAT].products[PROD].variantGroups[g].groupName || 'Adsƒ±z';
            showConfirm(
                'üóëÔ∏è Grup Sil',
                `<strong>"${grpName}"</strong> grubu silinecek.<br><br>Bu i≈ülem geri alƒ±namaz!`,
                () => {
                    DATA[CAT].products[PROD].variantGroups.splice(g,1); 
                    renderVars(DATA[CAT].products[PROD].variantGroups);
                    showUnsaved();
                },
                'Sil',
                'danger'
            );
        }
        window.delItem=(g,i)=>{ DATA[CAT].products[PROD].variantGroups[g].items.splice(i,1); renderVars(DATA[CAT].products[PROD].variantGroups); showUnsaved(); }
        
        // Global bir kilit deƒüi≈ükeni tanƒ±mlayalƒ±m (Script'in en tepesine de koyabilirsin ama burada da √ßalƒ±≈üƒ±r)
        let isSaving = false;

        async function saveGithub() { 
            // 1. Form Verilerini G√ºncelle (Eƒüer bir √ºr√ºn ve kategori se√ßiliyse)
            // Hata olursa (√∂rneƒüin √ºr√ºn silinmi≈üse) i≈ülemi durdurma, sadece logla ve devam et.
            if(PROD > -1 && CAT > -1) {
                try { 
                    if(typeof saveMem === 'function') saveMem(); 
                } catch(e) { 
                    console.warn("Form verisi okunamadƒ± (√∂nemli deƒüil, kayƒ±t devam ediyor):", e); 
                }
            }

            // 2. Buton ve Loader Ayarlarƒ±
            const btnSave = document.querySelector('.btn-success'); 
            if(btnSave) { btnSave.innerText = "Kaydediliyor..."; btnSave.style.opacity = "0.7"; }
            document.getElementById('loader').style.display = 'flex'; 

            try {
                // ADIM 0: Pending GLB dosyasƒ±nƒ± R2'ye y√ºkle (varsa)
                if(window.pendingGlbFile) {
                    const modelPath = document.getElementById('p-model').value;
                    const cleanPath = modelPath.startsWith('/') ? modelPath.slice(1) : modelPath;
                    console.log('üì§ GLB dosyasƒ± R2\'ye y√ºkleniyor:', cleanPath);
                    
                    try {
                        await fetch(WORKER_URL + "/upload/" + cleanPath, { 
                            method: "PUT", 
                            body: window.pendingGlbFile 
                        });
                        console.log('‚úÖ GLB dosyasƒ± R2\'ye y√ºklendi');
                        
                        // Pending dosyayƒ± temizle
                        window.pendingGlbFile = null;
                        document.getElementById('p-model').dataset.pendingUpload = 'false';
                        
                        // Local URL'yi temizle
                        if(localGlbUrl) {
                            URL.revokeObjectURL(localGlbUrl);
                            localGlbUrl = null;
                        }
                    } catch(uploadErr) {
                        console.error('‚ùå GLB y√ºkleme hatasƒ±:', uploadErr);
                        throw new Error('GLB dosyasƒ± R2\'ye y√ºklenemedi: ' + uploadErr.message);
                    }
                }

                // ADIM 1: G√úNCEL SHA'YI AL (√áakƒ±≈ümayƒ± √ñnlemek ƒ∞√ßin Kritik Hamle)
                const u = `https://api.github.com/repos/${CRED.owner}/${CRED.repo}/contents/${CRED.path}`; 
                // Kaydetmeden hemen √∂nce GitHub'dan dosyanƒ±n SON halinin kimliƒüini alƒ±yoruz.
                const getRes = await fetch(u + `?ref=${CRED.branch}`, {
                    method: 'GET',
                    headers: { 'Authorization': `token ${CRED.token}` }
                });

                if (!getRes.ok) throw new Error("GitHub baƒülantƒ± hatasƒ± (SHA alƒ±namadƒ±).");
                
                const currentData = await getRes.json();
                const freshSHA = currentData.sha; // ƒ∞≈üte en taze anahtar bu!

                // ADIM 2: YENƒ∞ VERƒ∞Yƒ∞ HAZIRLA VE G√ñNDER
                // Veriyi hazƒ±rlarken T√ºrk√ße karakter sorunu olmamasƒ± i√ßin encode ediyoruz
                const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(DATA, null, 2))));
                
                const body = {
                    message: "Upd v15.2 (Auto-Fix)", 
                    content: contentEncoded, 
                    sha: freshSHA, // Kendi elimizdeki eski SHA'yƒ± deƒüil, taze aldƒ±ƒüƒ±mƒ±zƒ± kullanƒ±yoruz.
                    branch: CRED.branch
                }; 

                const putRes = await fetch(u, {
                    method: 'PUT', 
                    headers: {
                        'Authorization': `token ${CRED.token}`,
                        'Content-Type': 'application/json'
                    }, 
                    body: JSON.stringify(body)
                }); 

                if (putRes.ok) { 
                    const resp = await putRes.json(); 
                    SHA = resp.content.sha; // Bizim yerel SHA'mƒ±zƒ± da g√ºncelle
                    console.log("‚úÖ Ba≈üarƒ±yla Kaydedildi! Yeni SHA:", SHA); 
                    clearUnsaved();
                    showAlert('‚úÖ Ba≈üarƒ±lƒ±', 'Deƒüi≈üiklikler GitHub\'a ba≈üarƒ±yla kaydedildi!', 'success'); 
                } else { 
                    const err = await putRes.json(); 
                    throw new Error("Kayƒ±t Hatasƒ±: " + (err.message || putRes.statusText)); 
                }

            } catch(e) { 
                console.error(e);
                showAlert('‚ùå Hata', e.message, 'error'); 
            } finally {
                // 3. Ortalƒ±ƒüƒ± Topla
                document.getElementById('loader').style.display = 'none';
                if(btnSave) { btnSave.innerText = "Deƒüi≈üiklikleri Kaydet"; btnSave.style.opacity = "1"; }
            }
        }
    </script>
</body>
</html>