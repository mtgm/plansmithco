<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanSmithCo CMS v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-w: 280px;
            --primary: #0f172a;
            --accent: #f59e0b;
            --border: #e2e8f0;
            --bg: #f8fafc;
            --surface: #ffffff;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--primary); height: 100vh; display: flex; overflow: hidden; }
        
        /* LOGIN & LOADER */
        #login-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* SIDEBAR */
        aside { width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .brand { padding: 20px; font-weight: 800; font-size: 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .tree-view { flex: 1; overflow-y: auto; padding: 10px; }
        .tree-item { padding: 10px; cursor: pointer; border-radius: 6px; font-size: 13px; font-weight: 500; margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between; transition: 0.1s; }
        .tree-item:hover { background: #f1f5f9; }
        .tree-item.active { background: #eff6ff; color: #2563eb; font-weight: 700; }
        .tree-cat { color: #94a3b8; font-size: 10px; font-weight: 800; text-transform: uppercase; margin: 20px 0 5px 10px; letter-spacing: 0.5px; }
        .actions { padding: 15px; border-top: 1px solid var(--border); display: grid; gap: 8px; }

        /* MAIN EDITOR */
        main { flex: 1; padding: 30px; overflow-y: auto; display: flex; justify-content: center; }
        .editor-container { width: 100%; max-width: 900px; background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 50px; }
        
        h2 { margin: 0 0 20px 0; font-size: 18px; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* FORMS */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-group.full { grid-column: span 2; }
        
        label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; transition: 0.2s; }
        input:focus, textarea:focus, select:focus { outline: 2px solid var(--accent); border-color: transparent; }
        
        /* BUTTONS */
        button { cursor: pointer; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; font-size: 12px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-success { background: #10b981; color: white; width: 100%; font-size: 14px; padding: 14px; }
        .btn-outline { background: white; border: 1px solid var(--border); color: #475569; }
        .btn-danger { background: #fee2e2; color: #ef4444; padding: 4px 8px; font-size: 10px; }
        
        /* VARYASYONLAR */
        .variant-section { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-top: 30px; }
        .v-group { background: white; padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; }
        .v-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .v-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .v-item { border: 1px solid var(--border); padding: 10px; border-radius: 6px; font-size: 11px; background: #fafafa; }
        .v-item input, .v-item select { margin-bottom: 6px; font-size: 11px; padding: 6px; background: white; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>üîê CMS Giri≈ü</h2>
            <div class="form-group"><label>GitHub Token</label><input type="password" id="gh-token"></div>
            <div class="form-group"><label>Kullanƒ±cƒ± (Owner)</label><input type="text" id="gh-owner" placeholder="PlanSmithCo"></div>
            <div class="form-group"><label>Repo</label><input type="text" id="gh-repo" placeholder="showroom"></div>
            <div class="form-group"><label>Branch</label><input type="text" id="gh-branch" value="main"></div>
            <div class="form-group"><label>Dosya Yolu</label><input type="text" id="gh-path" value="products.json"></div>
            <button class="btn-accent" style="width:100%" onclick="login()">BAƒûLAN</button>
        </div>
    </div>

    <div id="loader" class="loading-overlay"><div class="spinner"></div></div>

    <aside>
        <div class="brand">PlanSmithCo. <span>v2.0</span></div>
        <div class="tree-view" id="product-tree"></div>
        <div class="actions">
            <button class="btn-outline" onclick="addNewProduct()">+ Yeni √úr√ºn</button>
            <button class="btn-outline" onclick="addNewCategory()">+ Yeni Kategori</button>
            <button class="btn-primary" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
        </div>
    </aside>

    <main>
        <div class="editor-container hidden" id="editor">
            <h2>√úr√ºn D√ºzenle</h2>
            
            <div class="form-grid">
                <div class="form-group full" style="background:#fff7ed; padding:15px; border:1px solid #ffedd5; border-radius:8px;">
                    <label style="color:#d97706;">üìÇ KATEGORƒ∞</label>
                    <select id="inp-category" onchange="moveProductCategory()"></select>
                </div>

                <div class="form-group">
                    <label>√úr√ºn Adƒ±</label>
                    <input type="text" id="inp-name">
                </div>
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" id="inp-sku">
                </div>
                <div class="form-group">
                    <label>Fiyat ($)</label>
                    <input type="number" id="inp-price">
                </div>
                <div class="form-group">
                    <label>Poster Resmi</label>
                    <input type="text" id="inp-thumb" list="image-history" placeholder="/poster.webp">
                </div>
                <div class="form-group full">
                    <label>A√ßƒ±klama</label>
                    <textarea id="inp-desc" rows="3"></textarea>
                </div>
                <div class="form-group full">
                    <label>Etsy Linki</label>
                    <input type="text" id="inp-link">
                </div>
                <div class="form-group full">
                    <label>Master Model (.glb)</label>
                    <input type="text" id="inp-model" list="model-history" placeholder="/assets-r2/models/...">
                </div>
            </div>

            <div class="variant-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <label style="margin:0;">VARYASYON GRUPLARI</label>
                    <button class="btn-outline btn-small" onclick="addVariantGroup()">+ Grup Ekle</button>
                </div>
                <div id="variant-groups-container"></div>
            </div>

            <div style="margin-top:30px; padding-top:20px; border-top:1px solid #e2e8f0;">
                <button class="btn-success" onclick="saveToGithub()">üíæ DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ KAYDET</button>
            </div>
        </div>
        
        <div id="empty-state" style="display:flex; justify-content:center; align-items:center; height:100%; color:#cbd5e1; font-size:20px;">
            üëà Soldan bir √ºr√ºn se√ßin
        </div>
    </main>

    <datalist id="image-history"></datalist>
    <datalist id="model-history"></datalist>
    <datalist id="texture-history"></datalist>

    <script>
        // --- SIK KULLANILAN TEXTURE PRESETLERƒ∞ (Burasƒ± manuel tanƒ±mlanƒ±r) ---
        const TEXTURE_PRESETS = [
            { name: "√áam (Pine)", url: "/assets-r2/textures/1x2V3/dikme_baseColor.png" },
            { name: "Antrasit", url: "/assets-r2/textures/1x2V3/dark_grey_base.png" },
            { name: "Sarƒ± Plastik", url: "/assets-r2/textures/1x2V3/yellow_plastic_base.png" },
            { name: "Siyah Plastik", url: "/assets-r2/textures/1x2V3/black_plastic_base.png" },
            // Buraya kendi R2 linklerini ekleyebilirsin
        ];

        let allData = [];
        let currentCatIndex = -1;
        let currentProdIndex = -1;
        
        // GH Config
        let GH_TOKEN="", GH_OWNER="", GH_REPO="", GH_BRANCH="", GH_PATH="", FILE_SHA="";

        // 1. Gƒ∞Rƒ∞≈û
        window.onload = () => {
            if(localStorage.getItem('gh_token')) {
                ['token','owner','repo','branch','path'].forEach(k => 
                    document.getElementById('gh-'+k).value = localStorage.getItem('gh_'+k) || '');
            }
        };

        async function login() {
            ['token','owner','repo','branch','path'].forEach(k => {
                const val = document.getElementById('gh-'+k).value;
                window['GH_'+k.toUpperCase()] = val;
                localStorage.setItem('gh_'+k, val);
            });

            document.getElementById('loader').style.display = 'flex';
            try {
                await fetchFromGithub();
                document.getElementById('login-overlay').style.display = 'none';
                renderTree();
                populateHistory(); // Akƒ±llƒ± listeleri doldur
            } catch (e) { alert(e.message); } 
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        function logout() { localStorage.clear(); location.reload(); }

        // 2. GITHUB IO
        async function fetchFromGithub() {
            const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}?ref=${GH_BRANCH}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${GH_TOKEN}` } });
            if(!res.ok) throw new Error("GitHub Baƒülantƒ± Hatasƒ±! Bilgileri kontrol et.");
            const data = await res.json();
            FILE_SHA = data.sha;
            allData = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
        }

        async function saveToGithub() {
            if(!confirm("Site g√ºncellenecek. Onaylƒ±yor musun?")) return;
            if(currentProdIndex > -1) saveFormToMemory(); // Son hali kaydet

            document.getElementById('loader').style.display = 'flex';
            try {
                const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(allData, null, 2))));
                const body = { message: "CMS Update", content, sha: FILE_SHA, branch: GH_BRANCH };
                
                const res = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GH_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if(!res.ok) throw new Error("Kaydetme Ba≈üarƒ±sƒ±z");
                const data = await res.json();
                FILE_SHA = data.content.sha;
                alert("‚úÖ Ba≈üarƒ±lƒ±! Site 1-2 dk i√ßinde g√ºncellenir.");
            } catch (e) { alert(e.message); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        // 3. UI & LOGIC
        function renderTree() {
            const tree = document.getElementById('product-tree');
            tree.innerHTML = '';
            
            // Kategori Dropdown'ƒ±nƒ± da doldur (Formdaki)
            const catSelect = document.getElementById('inp-category');
            catSelect.innerHTML = '';

            allData.forEach((cat, cIdx) => {
                // Dropdown i√ßin se√ßenek
                const option = document.createElement('option');
                option.value = cIdx;
                option.text = cat.name;
                catSelect.appendChild(option);

                // Sidebar Aƒüacƒ±
                const catTitle = document.createElement('div');
                catTitle.className = 'tree-cat';
                catTitle.innerHTML = `${cat.name} <button class="btn-danger" style="float:right" onclick="removeCategory(${cIdx})">x</button>`;
                tree.appendChild(catTitle);

                cat.products.forEach((prod, pIdx) => {
                    const item = document.createElement('div');
                    item.className = `tree-item ${cIdx === currentCatIndex && pIdx === currentProdIndex ? 'active' : ''}`;
                    item.innerText = prod.name || 'ƒ∞simsiz';
                    item.onclick = () => loadProduct(cIdx, pIdx);
                    tree.appendChild(item);
                });
            });
        }

        function loadProduct(cIdx, pIdx) {
            if(currentProdIndex > -1) saveFormToMemory(); // Eskiyi kaydet
            
            currentCatIndex = cIdx;
            currentProdIndex = pIdx;
            const prod = allData[cIdx].products[pIdx];

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('editor').classList.remove('hidden');
            renderTree();

            // Form Doldur
            document.getElementById('inp-category').value = cIdx; // Kategori Se√ßimi
            document.getElementById('inp-name').value = prod.name || '';
            document.getElementById('inp-sku').value = prod.sku || '';
            document.getElementById('inp-price').value = prod.price || 0;
            document.getElementById('inp-desc').value = prod.description || '';
            document.getElementById('inp-link').value = prod.listingUrl || '';
            document.getElementById('inp-model').value = prod.masterModel || '';
            document.getElementById('inp-thumb').value = prod.thumbnail || '';

            renderVariantGroups(prod.variantGroups || []);
        }

        function saveFormToMemory() {
            if(currentCatIndex === -1 || currentProdIndex === -1) return;
            const prod = allData[currentCatIndex].products[currentProdIndex];
            
            prod.name = document.getElementById('inp-name').value;
            prod.sku = document.getElementById('inp-sku').value;
            prod.price = parseFloat(document.getElementById('inp-price').value);
            prod.description = document.getElementById('inp-desc').value;
            prod.listingUrl = document.getElementById('inp-link').value;
            prod.masterModel = document.getElementById('inp-model').value;
            prod.thumbnail = document.getElementById('inp-thumb').value;
        }

        // --- KATEGORƒ∞ DEƒûƒ∞≈ûTƒ∞RME MANTIƒûI ---
        window.moveProductCategory = function() {
            const newCatIdx = parseInt(document.getElementById('inp-category').value);
            if(newCatIdx === currentCatIndex) return; // Deƒüi≈üiklik yok

            // Mevcut veriyi al
            saveFormToMemory();
            const productData = allData[currentCatIndex].products[currentProdIndex];

            // Eskiden sil
            allData[currentCatIndex].products.splice(currentProdIndex, 1);

            // Yeniye ekle
            allData[newCatIdx].products.push(productData);

            // Yeni indeksi ayarla ve yeniden y√ºkle
            currentCatIndex = newCatIdx;
            currentProdIndex = allData[newCatIdx].products.length - 1;
            
            renderTree();
            // loadProduct √ßaƒüƒ±rmƒ±yoruz √ß√ºnk√º zaten formdaki veri hafƒ±zada
        }

        // --- VARYASYONLAR ---
        function renderVariantGroups(groups) {
            const container = document.getElementById('variant-groups-container');
            container.innerHTML = '';

            groups.forEach((group, gIdx) => {
                const gDiv = document.createElement('div');
                gDiv.className = 'v-group';
                gDiv.innerHTML = `
                    <div class="v-header">
                        <input type="text" value="${group.groupName}" oninput="updateGroupName(${gIdx}, this.value)" style="width:200px; font-weight:bold;">
                        <button class="btn-danger" onclick="removeGroup(${gIdx})">Grubu Sil</button>
                    </div>
                    <div class="v-items" id="v-items-${gIdx}"></div>
                    <button class="btn-outline btn-small" style="width:100%; margin-top:8px;" onclick="addVariantItem(${gIdx})">+ Se√ßenek Ekle</button>
                `;
                container.appendChild(gDiv);

                const itemsDiv = document.getElementById(`v-items-${gIdx}`);
                group.items.forEach((item, iIdx) => {
                    const iDiv = document.createElement('div');
                    iDiv.className = 'v-item';
                    
                    // PRESET SE√áƒ∞Mƒ∞ (Texture)
                    let presetOptions = `<option value="">Hazƒ±r Listeden Se√ß...</option>`;
                    TEXTURE_PRESETS.forEach(p => {
                        presetOptions += `<option value="${p.url}">${p.name}</option>`;
                    });

                    iDiv.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="font-weight:700; color:#cbd5e1;">#${iIdx+1}</span>
                            <button class="btn-danger" style="padding:0 4px;" onclick="removeItem(${gIdx}, ${iIdx})">x</button>
                        </div>
                        <label>Ad</label>
                        <input type="text" value="${item.name}" oninput="updateItem(${gIdx}, ${iIdx}, 'name', this.value)">
                        
                        <label>Buton G√∂rseli/Renk</label>
                        <input type="text" value="${item.value}" list="texture-history" oninput="updateItem(${gIdx}, ${iIdx}, 'value', this.value)">
                        
                        <label>3D Malzeme Adƒ±</label>
                        <input type="text" value="${item.textureConfig?.materialName || ''}" oninput="updateItemConfig(${gIdx}, ${iIdx}, 'materialName', this.value)">
                        
                        <label>Doku (BaseColor)</label>
                        <select onchange="updateItemConfig(${gIdx}, ${iIdx}, 'baseColor', this.value); this.previousElementSibling.value=this.value;" style="margin-bottom:5px;">
                            ${presetOptions}
                        </select>
                        <input type="text" placeholder="Veya manuel link..." value="${item.textureConfig?.baseColor || ''}" list="texture-history" oninput="updateItemConfig(${gIdx}, ${iIdx}, 'baseColor', this.value)">
                    `;
                    itemsDiv.appendChild(iDiv);
                });
            });
        }

        // --- AKILLI GE√áMƒ∞≈û (SMART HISTORY) ---
        function populateHistory() {
            const images = new Set();
            const models = new Set();
            const textures = new Set();

            // JSON'daki t√ºm linkleri tara
            allData.forEach(cat => {
                cat.products.forEach(p => {
                    if(p.thumbnail) images.add(p.thumbnail);
                    if(p.masterModel) models.add(p.masterModel);
                    p.variantGroups?.forEach(g => {
                        g.items.forEach(i => {
                            if(i.value && i.value.includes('/')) textures.add(i.value);
                            if(i.textureConfig?.baseColor) textures.add(i.textureConfig.baseColor);
                        });
                    });
                });
            });

            // Datalistleri doldur
            fillDatalist('image-history', images);
            fillDatalist('model-history', models);
            fillDatalist('texture-history', textures);
        }

        function fillDatalist(id, set) {
            const dl = document.getElementById(id);
            dl.innerHTML = '';
            set.forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                dl.appendChild(opt);
            });
        }

        // --- CRUD HELPERS ---
        window.updateGroupName = (gIdx, val) => { allData[currentCatIndex].products[currentProdIndex].variantGroups[gIdx].groupName = val; }
        window.updateItem = (gIdx, iIdx, key, val) => { allData[currentCatIndex].products[currentProdIndex].variantGroups[gIdx].items[iIdx][key] = val; }
        window.updateItemConfig = (gIdx, iIdx, key, val) => {
            let item = allData[currentCatIndex].products[currentProdIndex].variantGroups[gIdx].items[iIdx];
            if(!item.textureConfig) item.textureConfig = {};
            item.textureConfig[key] = val;
        }
        window.addVariantGroup = () => {
            let prod = allData[currentCatIndex].products[currentProdIndex];
            if(!prod.variantGroups) prod.variantGroups = [];
            prod.variantGroups.push({ groupName: "Yeni Grup", items: [] });
            renderVariantGroups(prod.variantGroups);
        }
        window.addVariantItem = (gIdx) => {
            let prod = allData[currentCatIndex].products[currentProdIndex];
            prod.variantGroups[gIdx].items.push({ name: "Yeni", type: "texture", value: "", textureConfig: {} });
            renderVariantGroups(prod.variantGroups);
        }
        window.removeGroup = (gIdx) => { if(confirm("Sil?")) { allData[currentCatIndex].products[currentProdIndex].variantGroups.splice(gIdx, 1); renderVariantGroups(allData[currentCatIndex].products[currentProdIndex].variantGroups); }}
        window.removeItem = (gIdx, iIdx) => { allData[currentCatIndex].products[currentProdIndex].variantGroups[gIdx].items.splice(iIdx, 1); renderVariantGroups(allData[currentCatIndex].products[currentProdIndex].variantGroups); }
        
        window.addNewProduct = () => {
            if(currentCatIndex === -1) currentCatIndex = 0; // Kategori se√ßili deƒüilse ilkine ekle
            if(allData.length === 0) { alert("√ñnce kategori olu≈ütur!"); return; }
            
            const newProd = { name: "Yeni √úr√ºn", sku: "NEW", price: 0, variantGroups: [] };
            allData[currentCatIndex].products.push(newProd);
            renderTree();
            loadProduct(currentCatIndex, allData[currentCatIndex].products.length - 1);
        }
        window.addNewCategory = () => {
            const name = prompt("Kategori Adƒ±:");
            if(name) { allData.push({ id: "cat_"+Date.now(), name: name, products: [] }); renderTree(); }
        }
        window.removeCategory = (idx) => { if(confirm("Emin misin?")) { allData.splice(idx, 1); renderTree(); document.getElementById('editor').classList.add('hidden'); }}
    </script>
</body>
</html>